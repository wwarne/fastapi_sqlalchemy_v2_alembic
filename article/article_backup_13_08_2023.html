<!DOCTYPE html> <html style lang=en><!--
 Page saved with SingleFile 
 url: https://thedmitry.pw/blog/2023/08/fastapi-async-sqlalchemy-pytest-and-alembic/ 
 saved date: Sun Aug 13 2023 11:18:14 GMT+0300 (Moscow Standard Time)
--><meta charset=utf-8>
<meta http-equiv=X-UA-Compatible content="IE=edge">
<title>Fastapi, async SQLAlchemy, pytest, and Alembic (all using asyncpg)</title>
<meta name=HandheldFriendly content=True>
<meta name=viewport content="width=device-width, initial-scale=1.0">
<style>:root{--sf-img-1: url("data:image/jpeg;base64,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")}a,article,aside,body,code,div,figcaption,figure,footer,h1,h2,h3,h4,header,html,img,li,nav,ol,p,pre,section,span,strong,sup,time,ul{margin:0;padding:0;border:0;font:inherit;font-size:100%;vertical-align:baseline}img{max-width:100%}html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}a{background-color:transparent}a:active,a:hover{outline:0}strong{font-weight:700}sup{position:relative;font-size:75%;line-height:0;vertical-align:baseline}sup{top:-.5em}img{border:0}svg:not(:root){overflow:hidden}code{font-family:monospace,monospace}html{overflow-y:scroll;font-size:62.5%;-webkit-tap-highlight-color:rgba(0,0,0,0)}body,html{overflow-x:hidden}body{color:#313b3f;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;font-size:1.6rem;line-height:1.6em;font-weight:400;font-style:normal;letter-spacing:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-moz-font-feature-settings:"liga"on}::-moz-selection{text-shadow:none;background:#cbeafb}::selection{text-shadow:none;background:#cbeafb}img,svg{vertical-align:middle}p{margin:0 0 1.5em}ol,ul{padding-left:1.3em;padding-right:1.5em}ul{list-style:disc}ol{list-style:decimal}ol,ul{max-width:100%}li{margin:.5em 0;padding-left:.3em;line-height:1.6em}a{color:#26a8ed;text-decoration:none}a:hover{text-decoration:underline}h1,h2,h3,h4{margin-top:0;line-height:1.15;font-weight:600;text-rendering:optimizeLegibility}h1{font-size:5.5rem;font-weight:600}@media (max-width:500px){h1{font-size:2.2rem}}h2{font-size:2.2rem}@media (max-width:500px){h2{font-size:1.8rem}}@media (max-width:500px){h3{font-size:1.7rem}}body{background:#fff}.site-wrapper{display:flex;flex-direction:column;min-height:100vh}.site-main{z-index:100;flex-grow:1}.outer{position:relative;padding:0 5vw}.inner{margin:0 auto;max-width:1140px;width:100%}.site-nav-main{position:fixed;top:0;right:0;left:0;z-index:1000;background:#090a0b}.site-nav{position:relative;z-index:100;display:flex;justify-content:space-between;align-items:flex-start;overflow:hidden;height:64px;font-size:1.3rem}.site-nav-left-wrapper{position:relative;flex:1 0 auto;display:flex}.site-header-background:not(.responsive-header-img) .site-nav-left-wrapper:after,.site-nav-main .site-nav-left-wrapper:after{content:"";position:absolute;top:0;z-index:1000;width:40px;height:100%;right:0;background:linear-gradient(90deg,rgba(9,10,11,0)0,#090a0b)}.site-nav-left{flex:1 0 auto;display:flex;align-items:center;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;margin-right:10px;padding:10px 0 80px;font-weight:500;letter-spacing:.2px;text-transform:uppercase;white-space:nowrap;-ms-overflow-scrolling:touch}.site-nav-left .nav li:last-of-type{padding-right:20px}.site-nav-logo{position:relative;z-index:100;flex-shrink:0;display:inline-block;margin-right:32px;padding:12px 0;color:#fff;font-size:1.7rem;line-height:1.8rem;font-weight:700;letter-spacing:-.5px;text-transform:none}.site-nav-logo:hover{text-decoration:none}.site-nav-content{position:relative;align-self:flex-start}.nav{position:absolute;z-index:1000;display:flex;margin:0 0 0-12px;padding:0;list-style:none;transition:all 1s cubic-bezier(.19,1,.22,1)}.nav li{display:block;margin:0;padding:0}.nav li a{position:relative;display:block;padding:12px;color:#fff;opacity:.8;transition:opacity .35s ease-in-out}.nav li a:hover{text-decoration:none;opacity:1}.nav li a:before{content:"";position:absolute;right:100%;bottom:8px;left:12px;height:1px;background:#fff;opacity:.25;transition:all .35s ease-in-out}.nav li a:hover:before{right:12px;opacity:.5}.nav-post-title{visibility:hidden;position:absolute;top:9px;color:#fff;font-size:1.7rem;font-weight:400;text-transform:none;opacity:0;transition:all 1s cubic-bezier(.19,1,.22,1);transform:translateY(175%)}.nav-post-title.dash{left:-25px}.nav-post-title.dash:before{content:"– ";opacity:.5}.site-nav-right{flex:0 1 auto;display:flex;justify-content:flex-end;align-items:center;padding:10px 0;height:64px}.social-links{flex-shrink:0;display:flex;align-items:center}.rss-button{padding:10px 8px;opacity:.8}.rss-button:hover{opacity:1}.rss-button svg{margin-bottom:1px;height:2.1rem;fill:#fff}/*!* Special behaviors for home navigation *!*/.post-card{position:relative;display:flex}.post-card{flex:1 1 301px;flex-direction:column;overflow:hidden;margin:0 0 40px;padding:0 20px 40px;min-height:220px;background-size:cover}.post-card-content-link{position:relative;display:block;color:#15171a}.post-card-content-link:hover{text-decoration:none}.post-card-header{margin:15px 0 0}.no-image .post-card-header{margin-top:0}.post-card-primary-tag{margin:0 0 .2em;font-size:1.2rem;font-weight:500;letter-spacing:.2px;text-transform:uppercase}.post-card-title{margin:0 0 .4em;line-height:1.15em}.no-image .post-card-title{margin-top:0}.post-card-content{flex-grow:1;display:flex;flex-direction:column}.post-card-excerpt{max-width:56em;font-family:Georgia,serif}.post-card-excerpt p{margin-bottom:1em}.post-card-meta{display:flex;align-items:flex-start;padding:0}.author-profile-image{display:block;width:100%;height:100%;background:#e3e9ed;border-radius:100%;-o-object-fit:cover;object-fit:cover}.author-list{display:flex;flex-wrap:wrap;margin:0 0 0 4px;padding:0;list-style:none}.author-list-item{position:relative;flex-shrink:0;margin:0;padding:0}.static-avatar{display:block;overflow:hidden;margin:0 0 0-6px;width:34px;height:34px;border:2px solid #fff;border-radius:100%}.author-name-tooltip{position:absolute;bottom:105%;z-index:999;display:block;padding:2px 8px;color:#fff;font-size:1.2rem;letter-spacing:.2px;white-space:nowrap;background:#15171a;border-radius:3px;box-shadow:0 12px 26px rgba(39,44,49,.08),1px 3px 8px rgba(39,44,49,.03);opacity:0;transition:all .35s cubic-bezier(.4,.01,.165,.99);transform:translateY(6px);pointer-events:none}.author-list-item:hover .author-name-tooltip{opacity:1;transform:translateY(0)}@media (max-width:700px){.author-name-tooltip{display:none}}.post-card-byline-content{flex:1 1 50%;display:flex;flex-direction:column;margin:2px 0 0 6px;font-size:1.2rem;line-height:1.4em;font-weight:400;letter-spacing:.2px;text-transform:uppercase}.post-card-byline-content span{margin:0}.post-card-byline-content a{font-weight:600}.post-card-byline-date{font-size:1.2rem}.post-card-byline-date .bull{display:inline-block;margin:0 4px;opacity:.6}@media (max-width:1170px){.post-card{margin-bottom:5vw}}@media (max-width:650px){.post-card{margin-bottom:5vw}}@media (max-width:500px){.post-card-title{font-size:1.9rem}.post-card-excerpt{font-size:1.6rem}}.post-template .site-main{margin-top:64px;padding-bottom:4vw;background:#fff}.post-full-header{position:relative;margin:0 auto;padding:50px 170px;border-top-left-radius:3px;border-top-right-radius:3px}.post-full-tags{display:flex;justify-content:flex-start;align-items:center;color:#738a94;line-height:1.4em;font-weight:600}@media (max-width:1170px){.post-full-header{padding:60px 11vw 50px}}@media (max-width:800px){.post-full-header{padding-right:5vw;padding-left:5vw}}@media (max-width:500px){.post-full-header{padding:20px 0 35px}}.post-full-title{margin:0 0 .2em;color:#090a0b}.post-full-custom-excerpt{margin:20px 0 0;color:#738a94;font-family:Georgia,serif;font-size:2.3rem;line-height:1.4em;font-weight:300}.post-full-content{position:relative;margin:0 auto;padding:0 170px 6vw;min-height:230px;font-family:Georgia,serif;font-size:2rem;line-height:1.6em;background:#fff}@media (max-width:1170px){.post-full-content{padding:0 11vw}}@media (max-width:800px){.post-full-content{padding:0 5vw;font-size:1.8rem}}@media (max-width:500px){.post-full-custom-excerpt{font-size:1.9rem;line-height:1.5em}}.no-image .post-full-content{padding-top:0}.no-image .post-full-content:after,.no-image .post-full-content:before{display:none}.post-full-content h1,.post-full-content h2,.post-full-content h3,.post-full-content h4,.post-full-content ol,.post-full-content p,.post-full-content pre,.post-full-content ul{margin:0 0 1.5em;min-width:100%}@media (max-width:500px){.post-full-content ol,.post-full-content p,.post-full-content pre,.post-full-content ul{margin-bottom:1.28em}}.post-full-content li{word-break:break-word}.post-full-content a{color:#15171a;word-break:break-word;box-shadow:inset 0-1px 0#15171a;transition:all .2s ease-in-out}.post-full-content a:hover{color:#3eb0ef;text-decoration:none;box-shadow:inset 0-1px 0#3eb0ef}.post-full-content strong{color:#090a0b}.post-full-content li:first-child{margin-top:0}.post-full-content img{display:block;max-width:1040px;height:auto}@media (max-width:1040px){.post-full-content img{width:100%}}.post-full-content code{padding:0 5px 2px;font-size:.8em;line-height:1em;font-weight:400!important;background:#e5eff5;border-radius:3px}.post-full-content p code{word-break:break-all}.post-full-content pre{overflow-x:auto;background:#0e0f11}.post-full-content pre ::-moz-selection{color:#3c484e}.post-full-content pre ::selection{color:#3c484e}.post-full-content pre code{padding:0;font-size:inherit;line-height:inherit;background:transparent}.post-full-content pre code :not(span){color:inherit}.post-full-content h1,.post-full-content h2,.post-full-content h3,.post-full-content h4{color:#090a0b;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif}.post-full-content h1{margin:.5em 0 .4em;font-size:4.2rem;line-height:1.25em;font-weight:600}.post-full-content p+h1{margin-top:.8em}@media (max-width:800px){.post-full-content h1{font-size:3.2rem;line-height:1.25em}}.post-full-content h2{margin:.5em 0 .4em;font-size:3.2rem;line-height:1.25em;font-weight:600}.post-full-content p+h2{margin-top:.8em}@media (max-width:800px){.post-full-content h2{margin-bottom:.3em;font-size:2.8rem;line-height:1.25em}}.post-full-content h3{margin:.5em 0 .2em;font-size:2.5rem;line-height:1.3em;font-weight:600}@media (max-width:800px){.post-full-content h3{margin-bottom:.3em;font-size:2.4rem;line-height:1.3em}}.post-full-content h4{margin:.5em 0 .2em;font-size:2.5rem;font-weight:600}@media (max-width:800px){.post-full-content h4{margin-bottom:.3em;font-size:2.4rem;line-height:1.3em}}@media (max-width:500px){.post-full-title{margin-top:.2em;font-size:4.2rem;line-height:1.05em}.post-full-content{padding:0}.post-full-content:after,.post-full-content:before{display:none}}.post-full-byline{display:flex;justify-content:space-between;margin:15px 0 0;padding-top:15px;border-top:1px solid #e3e9ed}.post-full-byline-content{flex-grow:1;display:flex;align-items:flex-start}.post-full-byline-content .author-list{justify-content:flex-start;padding:0 12px 0 0}.post-full-byline-meta{margin:2px 0 0;color:#92a3ab;font-size:1.2rem;line-height:1.2em;letter-spacing:.2px;text-transform:uppercase}.post-full-byline-meta h4{margin:0 0 3px;font-size:1.3rem;line-height:1.4em;font-weight:500}.post-full-byline-meta h4 a{color:#2b2f36}.post-full-byline-meta h4 a:hover{color:#15171a}.post-full-byline-meta .bull{display:inline-block;margin:0 4px;opacity:.6}.author-avatar{display:block;overflow:hidden;margin:0-4px;width:40px;height:40px;border:2px solid #fff;border-radius:100%;transition:all .5s cubic-bezier(.4,.01,.165,.99) .7s}.author-list-item .author-card{position:absolute;bottom:130%;left:50%;z-index:600;display:flex;justify-content:space-between;margin-left:-200px;width:400px;font-size:1.4rem;line-height:1.5em;background:#fff;border-radius:3px;box-shadow:0 12px 26px rgba(39,44,49,.08),1px 3px 8px rgba(39,44,49,.06);opacity:0;transition:all .35s cubic-bezier(.4,.01,.165,.99);transform:scale(.98) translateY(15px);pointer-events:none}.author-list-item .author-card:before{content:"";position:absolute;top:100%;left:50%;display:block;margin-left:-8px;width:0;height:0;border-top:8px solid #fff;border-right:8px solid transparent;border-left:8px solid transparent}.author-card{padding:20px 20px 22px}.author-card .author-info{flex:1 1 auto;padding:0 0 0 20px}.author-card .author-info h2{margin:8px 0 0;font-size:1.6rem}.author-card .author-info p{margin:4px 0 0;color:#5d7179}.author-card .author-profile-image{flex:0 0 60px;margin:0;width:60px;height:60px;border:none}@media (max-width:1170px){.author-list-item .author-card{margin-left:-50px;width:430px}.author-list-item .author-card:before{left:50px}}@media (max-width:650px){.author-list-item .author-card{display:none}}@media (max-width:500px){.author-avatar{width:36px;height:36px}.post-full-byline{margin-top:20px}.post-full-byline-meta{font-size:1.2rem}.post-full-byline-meta h4{margin-bottom:2px;font-size:1.2rem}}.read-next{border-bottom:1px solid hsla(0,0%,100%,.1);background:#090a0b}.read-next-feed{display:flex;flex-wrap:wrap;margin:0-25px;padding:60px 0 0}.read-next .post-card{padding-bottom:0;border-bottom:none}.read-next .post-card:after{display:none}.read-next .post-card-primary-tag{color:#fff;opacity:.6}.read-next .post-card-title{color:#fff;opacity:.8;transition:all .2s ease-in-out}.read-next .post-card-excerpt{color:hsla(0,0%,100%,.6)}.read-next .static-avatar{border-color:#000}.read-next .post-card-byline-content{color:hsla(0,0%,100%,.6)}.read-next .post-card-byline-content a{color:hsla(0,0%,100%,.8)}.read-next-card{position:relative;flex:0 1 326px;display:flex;flex-direction:column;overflow:hidden;margin:0 25px 50px;padding:25px;background:linear-gradient(#191b1f,#090a0b);border-radius:3px}.read-next-card a{transition:all .2s ease-in-out}.read-next-card a:hover{text-decoration:none}.read-next-card-header h3{margin:0;color:hsla(0,0%,100%,.6);font-size:1.2rem;line-height:1em;font-weight:300;letter-spacing:.4px;text-transform:uppercase}.read-next-card-header h3 a{color:#fff;font-weight:500;text-decoration:none;opacity:.8}.read-next-card-header h3 a:hover{opacity:1}.read-next-card-content{font-size:1.7rem}.read-next-card-content ul{display:flex;flex-direction:column;margin:0;padding:0;list-style:none}.read-next-card-content li{display:flex;flex-direction:column;align-items:flex-start;margin:0;padding:20px 0;border-bottom:hsla(0,0%,100%,.1)}.read-next-card-content li:last-of-type{padding-bottom:5px;border:none}.read-next-card-content h4{margin:0;font-size:1.6rem;line-height:1.35em;font-weight:600}.read-next-card-content li a{display:block;color:#fff;opacity:.8}.read-next-card-content li a:hover{opacity:1}.read-next-card-meta{margin-top:2px;font-size:1.2rem;line-height:1.4em;font-weight:400}.read-next-card-meta p{margin:0;color:hsla(0,0%,100%,.6)}.read-next-card-footer{position:relative;margin:40px 0 5px}.read-next-card-footer a{padding:7px 12px 8px 14px;border:1px solid hsla(0,0%,100%,.6);color:hsla(0,0%,100%,.6);font-size:1.3rem;border-radius:999px;transition:all .35s ease-in-out}.read-next-card-footer a:hover{border-color:#fecd35;color:#fecd35;text-decoration:none}@media (max-width:1170px){.read-next-card{flex:1 1 261px;margin-bottom:5vw}}@media (max-width:650px){.read-next-feed{flex-direction:column;padding:25px 0 0}.read-next-card{flex:1 1 auto;margin:0 25px;padding:0;background:none}.read-next .post-card{flex:1 1 auto;margin:25px;padding:25px 0 0;border-bottom:1px solid hsla(0,0%,100%,.1)}}.post-content{display:flex;flex-direction:column;align-items:center}.post-full-content .kg-image{margin:0 auto;max-width:100%}.post-full-content figure{margin:.8em 0 2.3em}.post-full-content figure img{margin:0}.post-full-content figcaption{margin:1em auto 0;color:#5d7179;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;font-size:75%;line-height:1.5em;text-align:center;max-width:1040px}.post-full-content .kg-bookmark-container{min-height:148px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif}.post-full-content .kg-bookmark-container,.post-full-content .kg-bookmark-container:hover{color:#15171a;text-decoration:none;box-shadow:0 2px 5px -1px rgba(0,0,0,.15),0 0 1px rgba(0,0,0,.09)}.kg-bookmark-title{color:#313b3f;transition:color .2s ease-in-out}.post-full-content .kg-bookmark-container:hover .kg-bookmark-title{color:#3eb0ef}.kg-bookmark-description{display:-webkit-box;color:#5d7179;-webkit-line-clamp:2;-webkit-box-orient:vertical}.kg-bookmark-thumbnail{max-height:100%}.kg-bookmark-thumbnail img{-o-object-fit:cover}.kg-bookmark-metadata{flex-wrap:wrap;color:#5d7179}.post-full-content .kg-bookmark-icon{margin-right:8px;width:22px;height:22px}.kg-bookmark-publisher{overflow:hidden;max-width:240px;line-height:1.5em;text-overflow:ellipsis;white-space:nowrap}@media (max-width:800px){.post-full-content figure{margin:.2em 0 1.3em}}@media (max-width:500px){.post-full-content figcaption{margin-bottom:.4em}.post-full-content .kg-bookmark-container{flex-direction:column}.kg-bookmark-description,.kg-bookmark-metadata,.kg-bookmark-title{font-size:1.4rem;line-height:1.5em}.post-full-content .kg-bookmark-icon{width:18px;height:18px}.kg-bookmark-thumbnail{order:1;min-height:160px;width:100%}.kg-bookmark-thumbnail img{border-radius:3px 3px 0 0}.kg-bookmark-content{order:2}}.site-footer{position:relative;padding-top:20px;padding-bottom:60px;color:#fff;background:#090a0b}.site-footer-content{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;font-size:1.3rem}.site-footer-content,.site-footer-content a{color:hsla(0,0%,100%,.7)}.site-footer-content a:hover{color:#fff;text-decoration:none}.site-footer-nav{display:flex}.site-footer-nav a{position:relative;margin-left:20px}.site-footer-nav a:before{content:"";position:absolute;top:11px;left:-11px;display:block;width:2px;height:2px;background:#fff;border-radius:100%}.site-footer-nav a:first-of-type:before{display:none}@media (max-width:650px){.site-footer-content{flex-direction:column}.site-footer-nav a:first-child{margin-left:0}}code[class*=language-],pre[class*=language-]{max-width:100vw}.text-center{text-align:center!important}.text-upper{text-transform:uppercase}.post-tags{font-size:.75em;margin-top:5px}#bottomHeader{height:3px;position:relative;top:0;left:-5vw}progress.reading-progress-bar{-webkit-appearance:none;-moz-appearance:none;appearance:none;position:absolute;width:100vw;height:3px;background:transparent;border:none}progress.reading-progress-bar[value]::-webkit-progress-bar{background-color:rgba(0,0,0,.5)}progress.reading-progress-bar[value]::-webkit-progress-value{background-color:#fa3c18}progress.reading-progress-bar[value]::-moz-progress-bar{background-color:#fa3c18}@-webkit-keyframes a{0%{-webkit-transform:translate(-50%,-50%) rotateX(0) rotateY(0);transform:translate(-50%,-50%) rotateX(0) rotateY(0)}50%{-webkit-transform:translate(-50%,-50%) rotateX(-180deg) rotateY(0);transform:translate(-50%,-50%) rotateX(-180deg) rotateY(0)}to{-webkit-transform:translate(-50%,-50%) rotateX(-180deg) rotateY(-180deg);transform:translate(-50%,-50%) rotateX(-180deg) rotateY(-180deg)}}@keyframes a{0%{-webkit-transform:translate(-50%,-50%) rotateX(0) rotateY(0);transform:translate(-50%,-50%) rotateX(0) rotateY(0)}50%{-webkit-transform:translate(-50%,-50%) rotateX(-180deg) rotateY(0);transform:translate(-50%,-50%) rotateX(-180deg) rotateY(0)}to{-webkit-transform:translate(-50%,-50%) rotateX(-180deg) rotateY(-180deg);transform:translate(-50%,-50%) rotateX(-180deg) rotateY(-180deg)}}.fluidbox__wrap{background-position:center center;background-size:cover;margin:0 auto;position:relative;-webkit-transition:all .5s ease-in-out;transition:all .5s ease-in-out}.fluidbox--closed .fluidbox__thumb{-webkit-transition:opacity 0s ease-in-out 0s;transition:opacity 0s ease-in-out 0s}.fluidbox__ghost{background-size:100% 100%;background-position:center center;background-repeat:no-repeat;position:absolute;-webkit-transition:opacity 0s 0s,-webkit-transform .5s 0s;transition:opacity 0s 0s,-webkit-transform .5s 0s;transition:opacity 0s 0s,transform .5s 0s,-webkit-transform .5s 0s}.fluidbox--closed .fluidbox__ghost{-webkit-transition:opacity 0s .5s,-webkit-transform .5s 0s;transition:opacity 0s .5s,-webkit-transform .5s 0s;transition:opacity 0s .5s,transform .5s 0s;transition:opacity 0s .5s,transform .5s 0s,-webkit-transform .5s 0s}.fluidbox__loader{opacity:0;-webkit-perspective:200px;perspective:200px;pointer-events:none;position:absolute;top:0;left:0;bottom:0;right:0}.fluidbox__loader:before{background-color:hsla(0,0%,100%,.85);content:"";-webkit-transform-style:preserve-3d;transform-style:preserve-3d;position:absolute;top:50%;left:50%;width:20%;padding-bottom:20%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);-webkit-transition-property:-webkit-transform;transition-property:-webkit-transform;transition-property:transform;transition-property:transform,-webkit-transform;-webkit-transition-duration:.5s;transition-duration:.5s;-webkit-transition-delay:0s;transition-delay:0s}#caption-overlay{position:fixed;bottom:2.5%;left:0;right:0;opacity:0;padding:1rem 0;background-color:hsla(0,0%,100%,.85);z-index:1011;text-align:center;transition:all .25s ease-in-out;transform:translateY(100%)}#caption-overlay .img-caption{color:#1d1d1d}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:.7em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#073642}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.comment{color:#93a1a1}.token.punctuation{color:#586e75}.token.boolean,.token.number{color:#268bd2}.token.builtin,.token.string{color:#2aa198}.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}</style>
<meta name=description content="We'll explore the integration of FastAPI with the new asynchronous SQLAlchemy 2.0, Alembic for migrations, and pytest for testing.
All of that with only asyncpg as our driver">
<link rel=canonical href=https://thedmitry.pw/blog/2023/08/fastapi-async-sqlalchemy-pytest-and-alembic/>
<meta name=referrer content=no-referrer-when-downgrade>
<link rel=amphtml href=https://thedmitry.pw/blog/2023/08/fastapi-async-sqlalchemy-pytest-and-alembic/amp/>
<meta name=generator content="Ghost 5.58">
<link rel=alternate type=application/rss+xml title="Dmitry's website" href=https://thedmitry.pw/rss/>
<link href=https://thedmitry.pw/webmentions/receive/ rel=webmention>
<style>.kg-bookmark-card,.kg-bookmark-card *{box-sizing:border-box}.kg-bookmark-card{position:relative;width:100%}.kg-bookmark-card a.kg-bookmark-container,.kg-bookmark-card a.kg-bookmark-container:hover{display:flex;text-decoration:none;border-radius:3px;border:1px solid rgb(124 139 154/25%);overflow:hidden;color:inherit}.kg-bookmark-content{display:flex;flex-direction:column;flex-grow:1;flex-basis:100%;align-items:flex-start;justify-content:flex-start;padding:20px;overflow:hidden}.kg-bookmark-title{font-size:1.5rem;line-height:1.4em;font-weight:600}.kg-bookmark-description{display:-webkit-box;font-size:1.4rem;line-height:1.5em;margin-top:3px;font-weight:400;max-height:44px;overflow-y:hidden;opacity:.7;-webkit-line-clamp:2;-webkit-box-orient:vertical}.kg-bookmark-metadata{display:flex;align-items:center;margin-top:22px;width:100%;font-size:1.4rem;font-weight:500;white-space:nowrap}.kg-bookmark-metadata>:not(img){opacity:.7}.kg-bookmark-publisher{display:inline}.kg-bookmark-metadata>span:nth-of-type(2){font-weight:400}.kg-bookmark-metadata>span:nth-of-type(2):before{content:"•";margin:0 6px}.kg-bookmark-metadata>span:last-of-type{overflow:hidden;text-overflow:ellipsis}.kg-bookmark-thumbnail{position:relative;flex-grow:1;min-width:33%}.kg-bookmark-thumbnail img{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;border-radius:0 2px 2px 0}.kg-image-card{--gap:1.2rem}@media (max-width:600px){.kg-image-card{--gap:0.6rem}}</style>
<noscript><p><img src="//stats.thedmitry.pw/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<style>:root{--ghost-accent-color:#15171A}@-webkit-keyframes App-logo-spin{from{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes App-logo-spin{from{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}</style><link rel=icon href=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAACXBIWXMAAAsTAAALEwEAmpwYAAABsElEQVRoge2bzY2DMBCFXwsctgEa2AMtcEkBVBCJFjjtnQ4QLXDjnBJICznmmha8QrIlizj+CVntjBlLLwfsjPzJ42djYQBQBxPWn/tBpGzgJXPdXcBzplp8wENmmmOAfzLRkAJ8Zq63gE9MtQv4m5k+AvzFRB8Fpl4EGDLCkJSeZQ5DTItqEZeGuDR2ufQI4KJ12xyjmOc9gCYiHe1YDyvOTT8bI+L8eUqrBK0QnaezsXGuACoOwEpr2glsoEkAtwBqrU53zNXhPiFWq1PaVf/vwK5Sb+akUZkYa4rIFBLABjo0yqFY1aZ+NTOywNAu6+twTKxQG1LATaB9dsCFo32dEKvhltLYAVw4HH+dIlkB19ay5FreGo7AlafOp3VdBnXgOtG0XmnSKU4euA9sD32QV/1/ewqQBi4cu63UjUdMIQM8BgwrG+DSsQd+ZTosgTtLrjccpVO7zAVYBfTwvLxnBzx6lhM2wBfHGZRZRsx5VhsAZQVMrQgwZIQhKT3LHIaYFtUiLg1xaYhLz/JhGo736eGJod4GPjNWMnAOGuQKAJ5HOEctco0HB7uopY6iX4sf4U+Wla9LAAAAAElFTkSuQmCC type=image/png><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class="post-template tag-python_tips tag-pytest tag-fastapi tag-sqlalchemy tag-alembic">
 <div class=site-wrapper>
 
<header class=site-header>
 <div class="outer site-nav-main">
 <div class=inner>
 <nav class=site-nav>
 <div class=site-nav-left-wrapper>
 <div class=site-nav-left>
 <a class=site-nav-logo href=https://thedmitry.pw/>Dmitry's website</a>
 <div class=site-nav-content>
 <ul class=nav>
 <li class=nav-home><a href=https://thedmitry.pw/>Home</a></li>
 <li class=nav-resume><a href=https://thedmitry.pw/resume/>Resume</a></li>
 <li class=nav-about-me><a href=https://thedmitry.pw/about/>About me</a></li>
</ul>
 <span class="nav-post-title dash">Fastapi, async SQLAlchemy, pytest, and Alembic (all using asyncpg)</span>
 </div>
 </div>
 </div>
 <div class=site-nav-right>
 <div class=social-links>
 </div>
 <a class=rss-button href=https://feedly.com/i/subscription/feed/https://thedmitry.pw/rss/ title=RSS target=_blank rel=noopener><svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24"><circle cx=6.18 cy=17.82 r=2.18></circle><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"></path></svg>
</a>
 </div>
</nav>
 </div>
 <div id=bottomHeader>
 <progress class=reading-progress-bar value=0.478953984773915></progress>
 </div>
</div></header>
<main id=site-main class="site-main outer">
 <div class=inner>
 <article class="post-full post tag-python_tips tag-pytest tag-fastapi tag-sqlalchemy tag-alembic no-image">
 <header class=post-full-header>
 <h1 class=post-full-title>Fastapi, async SQLAlchemy, pytest, and Alembic (all using asyncpg)</h1>
 <p class=post-full-custom-excerpt>We'll explore the integration of FastAPI with the new asynchronous SQLAlchemy 2.0, Alembic for migrations, and pytest for testing.
All of that with only asyncpg as our driver</p>
 <section class="post-full-tags post-tags text-center text-upper">
 <span><svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24" width=16 height=16><path fill=none d="M0 0h24v24H0z"></path><path d="M10.9 2.1l9.899 1.415 1.414 9.9-9.192 9.192a1 1 0 0 1-1.414 0l-9.9-9.9a1 1 0 0 1 0-1.414L10.9 2.1zm.707 2.122L3.828 12l8.486 8.485 7.778-7.778-1.06-7.425-7.425-1.06zm2.12 6.364a2 2 0 1 1 2.83-2.829 2 2 0 0 1-2.83 2.829z" fill=rgba(240,82,48,1)></path></svg></span>
 <a href=https://thedmitry.pw/tag/python_tips/ title=python_tips>&nbsp;python_tips&nbsp;</a>|
 <a href=https://thedmitry.pw/tag/pytest/ title=pytest>&nbsp;pytest&nbsp;</a>|
 <a href=https://thedmitry.pw/tag/fastapi/ title=fastapi>&nbsp;fastapi&nbsp;</a>|
 <a href=https://thedmitry.pw/tag/sqlalchemy/ title=sqlalchemy>&nbsp;sqlalchemy&nbsp;</a>|
 <a href=https://thedmitry.pw/tag/alembic/ title=alembic>&nbsp;alembic&nbsp;</a>|
 </section>
 <div class=post-full-byline>
 <section class=post-full-byline-content>
 <ul class=author-list>
 <li class=author-list-item>
 <div class=author-card>
 <img class=author-profile-image src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill-opacity="0"/></svg>' alt="Dmitry Plevkov" style="background-blend-mode:normal!important;background-clip:content-box!important;background-position:50% 50%!important;background-color:rgb(227,233,237)!important;background-image:var(--sf-img-1)!important;background-size:cover!important;background-origin:content-box!important;background-repeat:no-repeat!important">
 <div class=author-info>
 <h2>Dmitry Plevkov</h2>
 <p>Read <a href=https://thedmitry.pw/author/dmitry/>more posts</a> by this author.</p>
 </div>
 </div>
 <a href=https://thedmitry.pw/author/dmitry/ class=author-avatar>
 <img class=author-profile-image src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill-opacity="0"/></svg>' alt="Dmitry Plevkov" style="background-blend-mode:normal!important;background-clip:content-box!important;background-position:50% 50%!important;background-color:rgb(227,233,237)!important;background-image:var(--sf-img-1)!important;background-size:cover!important;background-origin:content-box!important;background-repeat:no-repeat!important">
 </a>
 </li>
 </ul>
 <section class=post-full-byline-meta>
 <h4 class=author-name><a href=https://thedmitry.pw/author/dmitry/>Dmitry Plevkov</a></h4>
 <div class=byline-meta-content>
 <time class=byline-meta-date datetime=2023-08-13>13 Aug 2023</time>
 <span class=byline-reading-time><span class=bull>•</span> 19 min read</span>
 </div>
 </section>
 </section>
 </div>
 </header>
 <section class=post-full-content>
 <div class=post-content>
 <h2 id=introduction>Introduction</h2>
<p>In this article, we'll explore the integration of FastAPI with the new asynchronous SQLAlchemy 2.0. Additionally, we'll delve into configuring pytest to execute asynchronous tests, allowing compatibility with pytest-xdist. We'll also cover the application of Alembic for db migrations with an asynchronous database driver.</p>
<p>The inspiration for this sparked as I delved into the insightful book "<a href="https://www.cosmicpython.com/book/preface.html?ref=thedmitry.pw">Architecture Patterns with Python</a>" authored by Harry Percival &amp; Bob Gregory.</p>
<p>I also encountered the captivating concept of the "Stairway test," which is eloquently detailed in the repository by <a href="https://github.com/alvassin/alembic-quickstart/tree/master?ref=thedmitry.pw">https://github.com/alvassin/alembic-quickstart/tree/master</a>. This concept profoundly resonated with me and led me to formulate the ideas presented in this post.</p>
<h3 id=reqirements>Reqirements</h3>
<p>I run this project using Python 3.9, probably you can easily adapt it to work on earlier versions.</p>
<p>I use poetry to manage project requirements.</p>
<p>Source code can be found <a href="https://github.com/wwarne/fastapi_sqlalchemy_v2_alembic?ref=thedmitry.pw">here</a></p>
<h2 id=install-dependencies>Install dependencies</h2>
<pre class="line-numbers language-bash"><code class=language-bash>$ poetry <span class="token function">add</span> fastapi uvicorn uvloop asyncpg alembic pydantic-settings
$ poetry <span class="token function">add</span> sqlalchemy --extras asyncio<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre>
<h3 id=install-dev-dependencies>Install dev dependencies</h3>
<pre class="line-numbers language-bash"><code class=language-bash>$ poetry <span class="token function">add</span> --group<span class="token operator">=</span>dev httpx sqlalchemy-utils pytest yarl mypy black isort<span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre>
<h1 id=setting-up-the-database>Setting up the database</h1>
<p>We're going to use FastAPI to create a straightforward API designed for user creation and retrieval from a database. Our primary objective is to illustrate the synergy between SQLAlchemy 2.0 and FastAPI, thus the API intricacies won't be our focal point in this context.</p>
<p>Let's start by creating a configuration file that will hold our database connection string. In my preference, I opt for leveraging <code>pydantic-settings</code> in scenarios of this nature. However, feel free to utilize any other method such as <code>os.getenv</code> if that aligns better with your workflow.</p>
<p>For the sake of clarity, I have encapsulated the entire database URI within a single parameter. It's important to note that in a real-world scenario, such configuration settings would likely be segregated into discrete entities like db_host, db_port, db_user, db_password, and more.</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># app/settings.py</span>
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path

<span class="token keyword">from</span> pydantic_settings <span class="token keyword">import</span> BaseSettings<span class="token punctuation">,</span> SettingsConfigDict


<span class="token keyword">class</span> <span class="token class-name">Settings</span><span class="token punctuation">(</span>BaseSettings<span class="token punctuation">)</span><span class="token punctuation">:</span>
    app_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"Example API"</span>
    app_host<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>
    app_port<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">3000</span>

    database_url<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"postgresql+asyncpg://blog_example_user:password@localhost:5432/blog_example_base"</span>

    project_root<span class="token punctuation">:</span> Path <span class="token operator">=</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span>

    model_config <span class="token operator">=</span> SettingsConfigDict<span class="token punctuation">(</span>env_file<span class="token operator">=</span><span class="token string">".env"</span><span class="token punctuation">)</span>


settings <span class="token operator">=</span> Settings<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>I'm not going to cover how to start a local PostgreSQL database in this post, but you can, for example use <a href="https://hub.docker.com/_/postgres?ref=thedmitry.pw">the official docker image</a> to start a local database.</p>
<p>To be able to run tests your database user should have <code>CREATEDB</code> privilege.</p>
<pre class="line-numbers language-sql"><code class=language-sql>Example <span class="token keyword">SQL</span> commands <span class="token keyword">to</span> <span class="token keyword">create</span> a new <span class="token keyword">user</span> <span class="token keyword">with</span> a new <span class="token keyword">database</span><span class="token punctuation">.</span>

<span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">"blog_example_user"</span> <span class="token keyword">WITH</span> PASSWORD <span class="token string">'password'</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token string">"blog_example_base"</span> OWNER <span class="token string">"blog_example_user"</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">USER</span> <span class="token string">"blog_example_user"</span> CREATEDB<span class="token punctuation">;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id=lets-create-our-orm-model>Let's create our ORM model</h3>
<p>I prefer to put all orm-related stuff into an <code>orm</code> module and use its <code>__init__.py</code></p>
<p>So in code i use it like <code>import orm</code> <code>query = select(orm.User)...</code></p>
<p>This way it's much easier to distinguish between SQLAlchemy models and my business models.</p>
<p>So, first let's add the base class</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># orm/base_model.py</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> MetaData
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> DeclarativeBase

<span class="token comment"># Default naming convention for all indexes and constraints</span>
<span class="token comment"># See why this is important and how it would save your time:</span>
<span class="token comment"># https://alembic.sqlalchemy.org/en/latest/naming.html</span>
convention <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"all_column_names"</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> constraint<span class="token punctuation">,</span> table<span class="token punctuation">:</span> <span class="token string">"_"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>column<span class="token punctuation">.</span>name <span class="token keyword">for</span> column <span class="token keyword">in</span> constraint<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"ix"</span><span class="token punctuation">:</span> <span class="token string">"ix__%(table_name)s__%(all_column_names)s"</span><span class="token punctuation">,</span>
    <span class="token string">"uq"</span><span class="token punctuation">:</span> <span class="token string">"uq__%(table_name)s__%(all_column_names)s"</span><span class="token punctuation">,</span>
    <span class="token string">"ck"</span><span class="token punctuation">:</span> <span class="token string">"ck__%(table_name)s__%(constraint_name)s"</span><span class="token punctuation">,</span>
    <span class="token string">"fk"</span><span class="token punctuation">:</span> <span class="token string">"fk__%(table_name)s__%(all_column_names)s__%(referred_table_name)s"</span><span class="token punctuation">,</span>
    <span class="token string">"pk"</span><span class="token punctuation">:</span> <span class="token string">"pk__%(table_name)s"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">OrmBase</span><span class="token punctuation">(</span>DeclarativeBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    metadata <span class="token operator">=</span> MetaData<span class="token punctuation">(</span>naming_convention<span class="token operator">=</span>convention<span class="token punctuation">)</span>  <span class="token comment"># type: ignore</span>


<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Then, let's create a session manager for our database. This class will be used as a singleton and will be responsible for abstracting the database connection and session handling:</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># orm/session_manager.py</span>
<span class="token keyword">import</span> contextlib
<span class="token keyword">from</span> typing <span class="token keyword">import</span> AsyncIterator<span class="token punctuation">,</span> Optional

<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> <span class="token punctuation">(</span>
    AsyncConnection<span class="token punctuation">,</span>
    AsyncEngine<span class="token punctuation">,</span>
    AsyncSession<span class="token punctuation">,</span>
    async_sessionmaker<span class="token punctuation">,</span>
    create_async_engine<span class="token punctuation">,</span>
<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">DatabaseSessionManager</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_engine<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>AsyncEngine<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>_sessionmaker<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>async_sessionmaker<span class="token punctuation">[</span>AsyncSession<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> db_url<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># Just additional example of customization.</span>
        <span class="token comment"># you can add parameters to init and so on</span>
        <span class="token keyword">if</span> <span class="token string">"postgresql"</span> <span class="token keyword">in</span> db_url<span class="token punctuation">:</span>
            <span class="token comment"># These settings are needed to work with pgbouncer in transaction mode</span>
            <span class="token comment"># because you can't use prepared statements in such case</span>
            connect_args <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string">"statement_cache_size"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">"prepared_statement_cache_size"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            connect_args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>_engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>
            url<span class="token operator">=</span>db_url<span class="token punctuation">,</span>
            pool_pre_ping<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            connect_args<span class="token operator">=</span>connect_args<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_sessionmaker <span class="token operator">=</span> async_sessionmaker<span class="token punctuation">(</span>
            bind<span class="token operator">=</span>self<span class="token punctuation">.</span>_engine<span class="token punctuation">,</span>
            expire_on_commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_engine <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>_engine<span class="token punctuation">.</span>dispose<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_engine <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>_sessionmaker <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token decorator annotation punctuation">@contextlib<span class="token punctuation">.</span>asynccontextmanager</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">session</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AsyncIterator<span class="token punctuation">[</span>AsyncSession<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_sessionmaker <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> IOError<span class="token punctuation">(</span><span class="token string">"DatabaseSessionManager is not initialized"</span><span class="token punctuation">)</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> self<span class="token punctuation">.</span>_sessionmaker<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">yield</span> session
            <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
                <span class="token keyword">await</span> session<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">raise</span>

    <span class="token decorator annotation punctuation">@contextlib<span class="token punctuation">.</span>asynccontextmanager</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AsyncIterator<span class="token punctuation">[</span>AsyncConnection<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_engine <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> IOError<span class="token punctuation">(</span><span class="token string">"DatabaseSessionManager is not initialized"</span><span class="token punctuation">)</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> self<span class="token punctuation">.</span>_engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">yield</span> connection
            <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
                <span class="token keyword">await</span> connection<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">raise</span>


db_manager <span class="token operator">=</span> DatabaseSessionManager<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Notice that we're we're using the async version of the <code>create_engine</code> method, which returns an <code>AsyncEngine</code> object. We will also use the async version of the <code>sessionmaker</code> method, which returns an <code>AsyncSession</code> object for committing and rolling back transactions.</p>
<p>We are going to use <code>init</code> and <code>close</code> methods in FastAPI's <a href="https://fastapi.tiangolo.com/advanced/events/?h=life&amp;ref=thedmitry.pw#lifespan">lifespan event</a>, to run it during startup and shutdown of our application.</p>
<p>The benefits of this approach are:</p>
<ul><li>You can connect to as many databases as needed, which was a problem for me with the middleware approach. (just create different DatabaseSessionManager for each database)<li>Your DB connections are released at application shutdown instead of garbage collection, which means you won't run into issues if you use <code>uvicorn --reload</code><li>Your DB sessions will automatically be closed when the route using <code>session</code> dependency finishes, so any uncommitted operations will be rolled back.</ul>
<p>Then, we need to create a FastAPI dependency that will be used to get the database session. This dependency will be used in the API views:</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># orm/session_manager.py</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AsyncSession<span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> db_manager<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> session<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span></span></code></pre>
<p>And we're done with the database configuration. Now we can create the database models (I just used the model from SQLAlchemy tutorial):</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># orm/user_model.py</span>

<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional

<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> String
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Mapped<span class="token punctuation">,</span> mapped_column

<span class="token keyword">from</span> <span class="token punctuation">.</span>base_model <span class="token keyword">import</span> OrmBase


<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>OrmBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"user_account"</span>

    <span class="token builtin">id</span><span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fullname<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span>Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"User(id=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, name=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, fullname=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>fullname<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)"</span></span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>It's the most modern form of Declarative, which is driven from <a href="https://peps.python.org/pep-0484/?ref=thedmitry.pw"><strong>PEP 484</strong></a> type annotations using a special type <a href="https://docs.sqlalchemy.org/en/20/orm/internals.html?ref=thedmitry.pw#sqlalchemy.orm.Mapped"><code>Mapped</code></a>, which indicates attributes to be mapped as particular types. </p>
<figure class="kg-card kg-bookmark-card kg-card-hascaption"><a class=kg-bookmark-container href="https://docs.sqlalchemy.org/en/20/tutorial/metadata.html?ref=thedmitry.pw#declaring-mapped-classes"><div class=kg-bookmark-content><div class=kg-bookmark-title>Working with Database Metadata — SQLAlchemy 2.0 Documentation</div><div class=kg-bookmark-description></div><div class=kg-bookmark-metadata><span href=https://www.sqlalchemy.org/favicon.ico class="zoom fluidbox__instance-1 fluidbox--initialized fluidbox--closed fluidbox--ready"><div class=fluidbox__wrap style=z-index:990><img class="kg-bookmark-icon fluidbox__thumb" src="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAABMLAAATCwAAAAAAAAAAAAB3iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/95inn/lKGU/77Hvv/R1tH/0NXQ/8XMxf+hraH/eot6/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/94iXj/uMG4//T29P/29/b/6+7r/+zv7P/8/fz//f79/8TLxP+QnZD/d4h3/3eId/93iHf/d4h3/3eId/95inn/uMC4//r7+v/N1M3/l6SX/4CQgP+Ek4T/naqd/9DW0P/7/Pv/5Ofk/4mYif93iHf/d4h3/3eId/93iHf/rrmu//39/f/FzMX/e4x7/3eId/+Il4j/i5qL/3eId/95iXn/tL20//3+/f/Hzsf/e4x7/3eId/93iHf/f49//+Hk4f/i5uL/gZCB/3eId/+wubD/7vDu//Dx8P+8xbz/fY19/3yNfP/T2NP/+fr5/56qnv93iHf/d4h3/5Gekf/x8vH/ucG5/3eId/+msab/7/Hv/8zSzP/L0sv/+fn5/7bAtv93iHf/q7ar//////+9xr3/d4h3/3eId/+ap5r/8/Tz/6SwpP9/j3//5unm/+Dk4P95iXn/d4h3/9ne2f/d4t3/fo5+/56qnv/8/fz/yM7I/3eId/93iHf/m6eb//n5+f+st6z/eIl4/9DW0P/z9PP/laKV/4uai//p6+n/0dbR/3mJef+iraL//f79/8bNxv93iHf/d4h3/4qYiv/o6+j/xs3G/3eId/+eqp7/8/Xz//Dx8P/u8O7/8/Xz/6CsoP93iHf/wcnB//7//v+4wLj/eYp5/3eId/95inn/vsa+//Hz8f+cqJz/d4h3/5ikmP/Gzcb/xc3F/5qmmv93iHf/k6CT//Dx8P/r7uv/kJ6Q/3iJeP93iHf/d4h3/4CPgP/c4dz/8/Xz/623rf94iHj/d4h3/3eId/93iHf/prGm/+vt6//8/fz/r7mv/3iIeP93iHf/d4h3/3eId/93iHf/maaZ/+Hl4f/5+vn/1drV/7K7sv+yvLL/0NXQ//z8/P/+//7/vMW8/3iJeP93iHf/d4h3/3eId/93iHf/d4h3/3eId/+CkoL/ucG5/+ns6f/29/b/+Pn4/+vt6//O1M7/qbOp/3uMe/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/+FlIX/lqSW/5mmmf+Hlof/eIl4/3eId/93iHf/d4h3/3eId/93iHf/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" alt style=opacity:1><div class=fluidbox__ghost style=width:22px;height:22px;top:0px;left:0px></div><div class=fluidbox__loader style=z-index:2></div></div></span><span class=kg-bookmark-publisher>The Database Toolkit for Python</span></div></div><div class=kg-bookmark-thumbnail><img src=data:image/png;base64,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 alt></div></a><figcaption><p><span>Read more about Declaring Mapped Classes</span></p></figcaption></figure>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># orm/__init__.py</span>
<span class="token triple-quoted-string string">"""
Data structures, used in project.

Add your new models here so Alembic could pick them up.

You may do changes in tables, then execute
`alembic revision --message="Your text" --autogenerate`
and alembic would generate new migration for you
in alembic/versions folder.
"""</span>
<span class="token keyword">from</span> <span class="token punctuation">.</span>base_model <span class="token keyword">import</span> OrmBase
<span class="token keyword">from</span> <span class="token punctuation">.</span>session_manager <span class="token keyword">import</span> db_manager<span class="token punctuation">,</span> get_session
<span class="token keyword">from</span> <span class="token punctuation">.</span>user_model <span class="token keyword">import</span> User

__all__ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"OrmBase"</span><span class="token punctuation">,</span> <span class="token string">"get_session"</span><span class="token punctuation">,</span> <span class="token string">"db_manager"</span><span class="token punctuation">,</span> <span class="token string">"User"</span><span class="token punctuation">]</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p></p>
<p>I use dunder init file in orm module to be able to use <code>import orm</code> and then call objects like <code>orm.db_manager</code>, <code>orm.User</code> etc... This approach substantially simplifies the distinction between your SQLAlchemy models and your business-oriented models.</p>
<h3 id=creating-the-api-views>Creating the API views</h3>
<p>Now that we have the database configuration and models set up, we can create the API views. </p>
<p>For simplicity I'm going to put all API related models and functions in one file so you can check it easily. In real life you probably should consider segmentation for organizational clarity.</p>
<p>Let's start by creating a models for validating incoming API request and providing a response:</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># api/user.py</span>
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span> ConfigDict<span class="token punctuation">,</span> Field

<span class="token keyword">class</span> <span class="token class-name">UserCreateRequest</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
    fullname<span class="token punctuation">:</span> <span class="token builtin">str</span>


<span class="token keyword">class</span> <span class="token class-name">UserResponse</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    fullname<span class="token punctuation">:</span> <span class="token builtin">str</span>

    model_config <span class="token operator">=</span> ConfigDict<span class="token punctuation">(</span>from_attributes<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Then you need to return a list of users, many people opt for a simplistic approach such as responding with something like <code>list[User]</code> . After some time they need to add some additional information to such endpoint, but it can't be done easily.</p>
<p>So it's better to use more flexible response structure from the beginning, like:</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># api/user.py</span>
<span class="token keyword">class</span> <span class="token class-name">APIUserResponse</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    status<span class="token punctuation">:</span> Literal<span class="token punctuation">[</span><span class="token string">'ok'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'ok'</span>
    data<span class="token punctuation">:</span> UserResponse


<span class="token keyword">class</span> <span class="token class-name">APIUserListResponse</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    status<span class="token punctuation">:</span> Literal<span class="token punctuation">[</span><span class="token string">'ok'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'ok'</span>
    data<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>UserResponse<span class="token punctuation">]</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>And, finally, our API views:</p>
<p>Few extra notes:</p>
<ul><li>Our UserResponse model has every field which is already json-compatible (strings and ints). That's why we can use <code>.model_dump()</code> . If your model have some types like <code>UUID</code> , <code>datetime</code>, other classes, - you can use <code>.model_dump(mode='json')</code> and pydantic will automatically convert output values to be json-supported types.<li>I prefer to return Response directly than use FastAPI's <code>response_model</code> conversion. For me it's more convenient plus it's actually faster. (You could check <a href="https://github.com/falkben/fastapi_experiments/?ref=thedmitry.pw">https://github.com/falkben/fastapi_experiments/</a> -&gt; orjson_response.py)<li>For the sake of simplicity I do ORM queries right in api views. In bigger project it's better to create additional service layer and put all your orm/sql queries in one module. If such queries spread through your code base you are going to regret it later.</ul>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># api/user.py</span>
<span class="token keyword">import</span> uuid
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Literal

<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> APIRouter<span class="token punctuation">,</span> Depends<span class="token punctuation">,</span> status
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> JSONResponse
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span> ConfigDict<span class="token punctuation">,</span> Field
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> select
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>exc <span class="token keyword">import</span> IntegrityError
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> AsyncSession

<span class="token keyword">import</span> orm


<span class="token keyword">class</span> <span class="token class-name">UserCreateRequest</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
    fullname<span class="token punctuation">:</span> <span class="token builtin">str</span>


<span class="token keyword">class</span> <span class="token class-name">UserResponse</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    fullname<span class="token punctuation">:</span> <span class="token builtin">str</span>

    model_config <span class="token operator">=</span> ConfigDict<span class="token punctuation">(</span>from_attributes<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">APIUserResponse</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    status<span class="token punctuation">:</span> Literal<span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"ok"</span>
    data<span class="token punctuation">:</span> UserResponse


<span class="token keyword">class</span> <span class="token class-name">APIUserListResponse</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    status<span class="token punctuation">:</span> Literal<span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"ok"</span>
    data<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>UserResponse<span class="token punctuation">]</span>


router <span class="token operator">=</span> APIRouter<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/{user_id}/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>APIUserResponse<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> session<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>orm<span class="token punctuation">.</span>get_session<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> JSONResponse<span class="token punctuation">:</span>
    user <span class="token operator">=</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>orm<span class="token punctuation">.</span>User<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">:</span>
        <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span>
            content<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"User not found"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_404_NOT_FOUND<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    response_model <span class="token operator">=</span> UserResponse<span class="token punctuation">.</span>model_validate<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span>
        content<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> response_model<span class="token punctuation">.</span>model_dump<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>APIUserListResponse<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span>session<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>orm<span class="token punctuation">.</span>get_session<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> JSONResponse<span class="token punctuation">:</span>
    users_results <span class="token operator">=</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span>select<span class="token punctuation">(</span>orm<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
    response_data <span class="token operator">=</span> <span class="token punctuation">[</span>
        UserResponse<span class="token punctuation">.</span>model_validate<span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">.</span>model_dump<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> u <span class="token keyword">in</span> users_results<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span>
        content<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> response_data<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>APIUserResponse<span class="token punctuation">,</span> status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_201_CREATED<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_user</span><span class="token punctuation">(</span>
    user_data<span class="token punctuation">:</span> UserCreateRequest<span class="token punctuation">,</span> session<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>orm<span class="token punctuation">.</span>get_session<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> JSONResponse<span class="token punctuation">:</span>
    user_candidate <span class="token operator">=</span> orm<span class="token punctuation">.</span>User<span class="token punctuation">(</span><span class="token operator">**</span>user_data<span class="token punctuation">.</span>model_dump<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user_candidate<span class="token punctuation">)</span>
    <span class="token comment"># I skip error handling</span>
    <span class="token keyword">await</span> session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> session<span class="token punctuation">.</span>refresh<span class="token punctuation">(</span>user_candidate<span class="token punctuation">)</span>
    response_model <span class="token operator">=</span> UserResponse<span class="token punctuation">.</span>model_validate<span class="token punctuation">(</span>user_candidate<span class="token punctuation">)</span>
    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span>
        content<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> response_model<span class="token punctuation">.</span>model_dump<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_201_CREATED<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Here we have a simple FastAPI router with three API views: <code>get_user</code>, <code>get_users</code> and <code>create_user</code>. Notice that we're using the <code>Depends</code> keyword to inject the database async session into the API views. This is how we can use the database session in the API views.</p>
<h1 id=setting-up-fastapi>Setting up FastAPI</h1>
<p>Now that we have the API views set up, we can create the FastAPI application.</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># main.py</span>
<span class="token keyword">import</span> contextlib
<span class="token keyword">from</span> typing <span class="token keyword">import</span> AsyncIterator

<span class="token keyword">import</span> uvicorn
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI

<span class="token keyword">import</span> orm
<span class="token keyword">from</span> api <span class="token keyword">import</span> user
<span class="token keyword">from</span> app<span class="token punctuation">.</span>settings <span class="token keyword">import</span> settings


<span class="token decorator annotation punctuation">@contextlib<span class="token punctuation">.</span>asynccontextmanager</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">lifespan</span><span class="token punctuation">(</span>app<span class="token punctuation">:</span> FastAPI<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AsyncIterator<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    orm<span class="token punctuation">.</span>db_manager<span class="token punctuation">.</span>init<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>database_url<span class="token punctuation">)</span>
    <span class="token keyword">yield</span>
    <span class="token keyword">await</span> orm<span class="token punctuation">.</span>db_manager<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">"Very simple example"</span><span class="token punctuation">,</span> lifespan<span class="token operator">=</span>lifespan<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>include_router<span class="token punctuation">(</span>user<span class="token punctuation">.</span>router<span class="token punctuation">,</span> prefix<span class="token operator">=</span><span class="token string">"/api/users"</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># There are a lot of parameters for uvicorn, you should check the docs</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
        app<span class="token punctuation">,</span>
        host<span class="token operator">=</span>settings<span class="token punctuation">.</span>app_host<span class="token punctuation">,</span>
        port<span class="token operator">=</span>settings<span class="token punctuation">.</span>app_port<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>In order for us to run our application, first we'll need to create our database tables. Let's see how we can do that using Alembic.</p>
<h3 id=migrations-with-alembic>Migrations with Alembic</h3>
<p>To start with alembic, we can use the <code>alembic init</code> command to create the alembic configuration. We'll use the <code>async</code> template for this: </p>
<pre class="line-numbers language-bash"><code class=language-bash>alembic init -t async alembic<span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre>
<p>This will create the <code>alembic</code> directory with the alembic configuration. We'll need to make a few changes to the configuration.</p>
<h3 id=alembicini><strong>alembic.ini</strong></h3>
<p>Uncomment the <code>file_template</code> line so names of the migrations will be more user- friendly and with dates so we can sort them.</p>
<p>Remove <code>sqlalchemy.url</code> string because we are going to set this parameter via <code>alembic/env.py</code> </p>
<h3 id=alembicenvpy>alembic/env.py</h3>
<p>First, we'll need to import our database models so that they're added to the <code>Base.metadata</code> object. This happens automatically when the model inherits from <code>OrmBase</code>, but we need to import the models to ensure that they're imported before the alembic configuration is loaded. Because we put all models into <code>orm/__init__.py</code> we can do <code>import orm</code> and models will be loaded.</p>
<p> Then, we need to set the <code>sqlalchemy.url</code> configuration to use our database connection string. </p>
<p>Important note - We are going to generate Alembic configuration for tests, so we need to be careful and not to rewrite <code>sqlalchemy.url</code> if it's already set.</p>
<p>And finally, we'll point the <code>target metadata</code> to our <code>Base.metadata</code> object.</p>
<p>Below I'll show the changes we need to make to the <code>alembic/env.py</code> file:</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># alembic/env.py</span>

<span class="token keyword">import</span> orm
<span class="token keyword">from</span> app<span class="token punctuation">.</span>settings <span class="token keyword">import</span> settings
current_url <span class="token operator">=</span> config<span class="token punctuation">.</span>get_main_option<span class="token punctuation">(</span><span class="token string">'sqlalchemy.url'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> current_url<span class="token punctuation">:</span>
    config<span class="token punctuation">.</span>set_main_option<span class="token punctuation">(</span><span class="token string">"sqlalchemy.url"</span><span class="token punctuation">,</span> settings<span class="token punctuation">.</span>database_url<span class="token punctuation">)</span>

target_metadata <span class="token operator">=</span> orm<span class="token punctuation">.</span>OrmBase<span class="token punctuation">.</span>metadata <span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Then, we're able to run the <code>alembic revision</code> command to create a new revision:</p>
<pre class="line-numbers language-bash"><code class=language-bash>alembic revision --autogenerate -m <span class="token string">"Add user model"</span><span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre>
<p>This will create a new revision file in the <code>alembic/versions</code> directory. We can then run the <code>alembic upgrade head</code> command to apply the migration to the database:</p>
<pre class="line-numbers language-bash"><code class=language-bash>alembic upgrade <span class="token function">head</span><span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre>
<p>To revert the last migration you could use </p>
<pre class="line-numbers language-bash"><code class=language-bash>alembic downgrade -1<span aria-hidden=true class=line-numbers-rows><span></span></span></code></pre>
<figure class="kg-card kg-bookmark-card kg-card-hascaption"><a class=kg-bookmark-container href="https://alembic.sqlalchemy.org/en/latest/tutorial.html?ref=thedmitry.pw"><div class=kg-bookmark-content><div class=kg-bookmark-title>Tutorial — Alembic 1.11.2 documentation</div><div class=kg-bookmark-description></div><div class=kg-bookmark-metadata><span href=https://sqlalchemy.org/favicon.ico class="zoom fluidbox__instance-2 fluidbox--initialized fluidbox--closed fluidbox--ready"><div class=fluidbox__wrap style=z-index:990><img class="kg-bookmark-icon fluidbox__thumb" src="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAABMLAAATCwAAAAAAAAAAAAB3iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/95inn/lKGU/77Hvv/R1tH/0NXQ/8XMxf+hraH/eot6/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/94iXj/uMG4//T29P/29/b/6+7r/+zv7P/8/fz//f79/8TLxP+QnZD/d4h3/3eId/93iHf/d4h3/3eId/95inn/uMC4//r7+v/N1M3/l6SX/4CQgP+Ek4T/naqd/9DW0P/7/Pv/5Ofk/4mYif93iHf/d4h3/3eId/93iHf/rrmu//39/f/FzMX/e4x7/3eId/+Il4j/i5qL/3eId/95iXn/tL20//3+/f/Hzsf/e4x7/3eId/93iHf/f49//+Hk4f/i5uL/gZCB/3eId/+wubD/7vDu//Dx8P+8xbz/fY19/3yNfP/T2NP/+fr5/56qnv93iHf/d4h3/5Gekf/x8vH/ucG5/3eId/+msab/7/Hv/8zSzP/L0sv/+fn5/7bAtv93iHf/q7ar//////+9xr3/d4h3/3eId/+ap5r/8/Tz/6SwpP9/j3//5unm/+Dk4P95iXn/d4h3/9ne2f/d4t3/fo5+/56qnv/8/fz/yM7I/3eId/93iHf/m6eb//n5+f+st6z/eIl4/9DW0P/z9PP/laKV/4uai//p6+n/0dbR/3mJef+iraL//f79/8bNxv93iHf/d4h3/4qYiv/o6+j/xs3G/3eId/+eqp7/8/Xz//Dx8P/u8O7/8/Xz/6CsoP93iHf/wcnB//7//v+4wLj/eYp5/3eId/95inn/vsa+//Hz8f+cqJz/d4h3/5ikmP/Gzcb/xc3F/5qmmv93iHf/k6CT//Dx8P/r7uv/kJ6Q/3iJeP93iHf/d4h3/4CPgP/c4dz/8/Xz/623rf94iHj/d4h3/3eId/93iHf/prGm/+vt6//8/fz/r7mv/3iIeP93iHf/d4h3/3eId/93iHf/maaZ/+Hl4f/5+vn/1drV/7K7sv+yvLL/0NXQ//z8/P/+//7/vMW8/3iJeP93iHf/d4h3/3eId/93iHf/d4h3/3eId/+CkoL/ucG5/+ns6f/29/b/+Pn4/+vt6//O1M7/qbOp/3uMe/93iHf/d4h3/3eId/93iHf/d4h3/3eId/93iHf/d4h3/3eId/+FlIX/lqSW/5mmmf+Hlof/eIl4/3eId/93iHf/d4h3/3eId/93iHf/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" alt style=opacity:1><div class=fluidbox__ghost style=width:22px;height:22px;top:0px;left:0px></div><div class=fluidbox__loader style=z-index:2></div></div></span></div></div></a><figcaption><p><span>More about alembic commands</span></p></figcaption></figure>
<h1 id=starting-the-server>Starting the server</h1>
<p>To start the server, run<code>python main.py</code>. This will start the server on port 8000 by default. The docs will be available at <code>http://localhost:8000/docs</code>. You should be able to see and run any of the API views that we've created.</p>
<p>This should be enough to start using FastAPI with SQLAlchemy 2.0. However, one important component of software development is testing, so let's see how we can test our API views.</p>
<h1 id=testing-the-api-views>Testing the API views</h1>
<p>For this section, my focus is primarily on demonstrating the mechanics of integration testing with FastAPI and SQLAlchemy 2.0. This means that our tests will call the API views and check the responses. While we won't be testing the database models, it's worth noting that a similar setup can be applied for such scenarios as well.</p>
<p>We'll start with the helper functions we are going to need:</p>
<p>The<code>sqlalchemy_utils</code> package have the two very useful functions - <code>create_database</code> and <code>drop_database.</code></p>
<p>Regrettably, these functions are synchronous and incompatible with the <code>asyncpg</code> driver. This typically leads tutorials to recommend the installation of <code>psycopg2</code> and the adoption of a separate synchronous engine for database creation. However, in the spirit of experimentation, we can just slightly modify such functions so they can use <code>create_async_engine</code> </p>
<p>You can see them in <a href="https://github.com/wwarne/fastapi_sqlalchemy_v2_alembic?ref=thedmitry.pw">Github repo</a></p>
<p>Next utils are:</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># tests/db_utils.py</span>
<span class="token keyword">import</span> contextlib
<span class="token keyword">import</span> uuid
<span class="token keyword">from</span> argparse <span class="token keyword">import</span> Namespace
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path
<span class="token keyword">from</span> typing <span class="token keyword">import</span> AsyncIterator<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Union

<span class="token keyword">import</span> sqlalchemy <span class="token keyword">as</span> sa
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> create_async_engine
<span class="token keyword">from</span> sqlalchemy_utils<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>database <span class="token keyword">import</span> <span class="token punctuation">(</span>
    _set_url_database<span class="token punctuation">,</span>
    _sqlite_file_exists<span class="token punctuation">,</span>
    make_url<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">from</span> sqlalchemy_utils<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>orm <span class="token keyword">import</span> quote
<span class="token keyword">from</span> yarl <span class="token keyword">import</span> URL

<span class="token keyword">from</span> alembic<span class="token punctuation">.</span>config <span class="token keyword">import</span> Config <span class="token keyword">as</span> AlembicConfig
<span class="token keyword">from</span> app<span class="token punctuation">.</span>settings <span class="token keyword">import</span> settings


<span class="token keyword">def</span> <span class="token function">make_alembic_config</span><span class="token punctuation">(</span>
    cmd_opts<span class="token punctuation">:</span> Namespace<span class="token punctuation">,</span> base_path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Path<span class="token punctuation">]</span> <span class="token operator">=</span> settings<span class="token punctuation">.</span>project_root
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AlembicConfig<span class="token punctuation">:</span>
    <span class="token comment"># Replace path to alembic.ini file to absolute</span>
    base_path <span class="token operator">=</span> Path<span class="token punctuation">(</span>base_path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> Path<span class="token punctuation">(</span>cmd_opts<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span>is_absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        cmd_opts<span class="token punctuation">.</span>config <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>base_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>cmd_opts<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span>absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    config <span class="token operator">=</span> AlembicConfig<span class="token punctuation">(</span>
        file_<span class="token operator">=</span>cmd_opts<span class="token punctuation">.</span>config<span class="token punctuation">,</span>
        ini_section<span class="token operator">=</span>cmd_opts<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        cmd_opts<span class="token operator">=</span>cmd_opts<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># Replace path to alembic folder to absolute</span>
    alembic_location <span class="token operator">=</span> config<span class="token punctuation">.</span>get_main_option<span class="token punctuation">(</span><span class="token string">"script_location"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> Path<span class="token punctuation">(</span>alembic_location<span class="token punctuation">)</span><span class="token punctuation">.</span>is_absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        config<span class="token punctuation">.</span>set_main_option<span class="token punctuation">(</span>
            <span class="token string">"script_location"</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>base_path<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>alembic_location<span class="token punctuation">)</span><span class="token punctuation">.</span>absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">if</span> cmd_opts<span class="token punctuation">.</span>pg_url<span class="token punctuation">:</span>
        config<span class="token punctuation">.</span>set_main_option<span class="token punctuation">(</span><span class="token string">"sqlalchemy.url"</span><span class="token punctuation">,</span> cmd_opts<span class="token punctuation">.</span>pg_url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> config


<span class="token keyword">def</span> <span class="token function">alembic_config_from_url</span><span class="token punctuation">(</span>pg_url<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AlembicConfig<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Provides python object, representing alembic.ini file."""</span>
    cmd_options <span class="token operator">=</span> Namespace<span class="token punctuation">(</span>
        config<span class="token operator">=</span><span class="token string">"alembic.ini"</span><span class="token punctuation">,</span>  <span class="token comment"># Config file name</span>
        name<span class="token operator">=</span><span class="token string">"alembic"</span><span class="token punctuation">,</span>  <span class="token comment"># Name of section in .ini file to use for Alembic config</span>
        pg_url<span class="token operator">=</span>pg_url<span class="token punctuation">,</span>  <span class="token comment"># DB URI</span>
        raiseerr<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># Raise a full stack trace on error</span>
        x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># Additional arguments consumed by custom env.py scripts</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> make_alembic_config<span class="token punctuation">(</span>cmd_opts<span class="token operator">=</span>cmd_options<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@contextlib<span class="token punctuation">.</span>asynccontextmanager</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">tmp_database</span><span class="token punctuation">(</span>db_url<span class="token punctuation">:</span> URL<span class="token punctuation">,</span> suffix<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AsyncIterator<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Context manager for creating new database and deleting it on exit."""</span>
    tmp_db_name <span class="token operator">=</span> <span class="token string">"."</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">,</span> <span class="token string">"tests-base"</span><span class="token punctuation">,</span> suffix<span class="token punctuation">]</span><span class="token punctuation">)</span>
    tmp_db_url <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>db_url<span class="token punctuation">.</span>with_path<span class="token punctuation">(</span>tmp_db_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> create_database_async<span class="token punctuation">(</span>tmp_db_url<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> tmp_db_url
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> drop_database_async<span class="token punctuation">(</span>tmp_db_url<span class="token punctuation">)</span>

<span class="token comment"># Next functions are copied from `sqlalchemy_utils` and slightly </span>
<span class="token comment"># modified to support async. Maybe </span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_database_async</span><span class="token punctuation">(</span>
    url<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> encoding<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"utf8"</span><span class="token punctuation">,</span> template<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> make_url<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    database <span class="token operator">=</span> url<span class="token punctuation">.</span>database
    dialect_name <span class="token operator">=</span> url<span class="token punctuation">.</span>get_dialect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name
    dialect_driver <span class="token operator">=</span> url<span class="token punctuation">.</span>get_dialect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>driver

    <span class="token keyword">if</span> dialect_name <span class="token operator">==</span> <span class="token string">"postgresql"</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> _set_url_database<span class="token punctuation">(</span>url<span class="token punctuation">,</span> database<span class="token operator">=</span><span class="token string">"postgres"</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> dialect_name <span class="token operator">==</span> <span class="token string">"mssql"</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> _set_url_database<span class="token punctuation">(</span>url<span class="token punctuation">,</span> database<span class="token operator">=</span><span class="token string">"master"</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> dialect_name <span class="token operator">==</span> <span class="token string">"cockroachdb"</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> _set_url_database<span class="token punctuation">(</span>url<span class="token punctuation">,</span> database<span class="token operator">=</span><span class="token string">"defaultdb"</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token keyword">not</span> dialect_name <span class="token operator">==</span> <span class="token string">"sqlite"</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> _set_url_database<span class="token punctuation">(</span>url<span class="token punctuation">,</span> database<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dialect_name <span class="token operator">==</span> <span class="token string">"mssql"</span> <span class="token keyword">and</span> dialect_driver <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token string">"pymssql"</span><span class="token punctuation">,</span> <span class="token string">"pyodbc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>
        dialect_name <span class="token operator">==</span> <span class="token string">"postgresql"</span>
        <span class="token keyword">and</span> dialect_driver <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token string">"asyncpg"</span><span class="token punctuation">,</span> <span class="token string">"pg8000"</span><span class="token punctuation">,</span> <span class="token string">"psycopg2"</span><span class="token punctuation">,</span> <span class="token string">"psycopg2cffi"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>url<span class="token punctuation">,</span> isolation_level<span class="token operator">=</span><span class="token string">"AUTOCOMMIT"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    <span class="token keyword">if</span> dialect_name <span class="token operator">==</span> <span class="token string">"postgresql"</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> template<span class="token punctuation">:</span>
            template <span class="token operator">=</span> <span class="token string">"template1"</span>

        <span class="token keyword">async</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
            text <span class="token operator">=</span> <span class="token string">"CREATE DATABASE {} ENCODING '{}' TEMPLATE {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                quote<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> quote<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> template<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">await</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>text<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">elif</span> dialect_name <span class="token operator">==</span> <span class="token string">"mysql"</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
            text <span class="token operator">=</span> <span class="token string">"CREATE DATABASE {} CHARACTER SET = '{}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                quote<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">,</span> encoding
            <span class="token punctuation">)</span>
            <span class="token keyword">await</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>text<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">elif</span> dialect_name <span class="token operator">==</span> <span class="token string">"sqlite"</span> <span class="token keyword">and</span> database <span class="token operator">!=</span> <span class="token string">":memory:"</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> database<span class="token punctuation">:</span>
            <span class="token keyword">async</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
                <span class="token keyword">await</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token string">"CREATE TABLE DB(id int)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">await</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token string">"DROP TABLE DB"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
            text <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"CREATE DATABASE </span><span class="token interpolation"><span class="token punctuation">{</span>quote<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token keyword">await</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>text<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> engine<span class="token punctuation">.</span>dispose<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">drop_database_async</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> make_url<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    database <span class="token operator">=</span> url<span class="token punctuation">.</span>database
    dialect_name <span class="token operator">=</span> url<span class="token punctuation">.</span>get_dialect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name
    dialect_driver <span class="token operator">=</span> url<span class="token punctuation">.</span>get_dialect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>driver

    <span class="token keyword">if</span> dialect_name <span class="token operator">==</span> <span class="token string">"postgresql"</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> _set_url_database<span class="token punctuation">(</span>url<span class="token punctuation">,</span> database<span class="token operator">=</span><span class="token string">"postgres"</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> dialect_name <span class="token operator">==</span> <span class="token string">"mssql"</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> _set_url_database<span class="token punctuation">(</span>url<span class="token punctuation">,</span> database<span class="token operator">=</span><span class="token string">"master"</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> dialect_name <span class="token operator">==</span> <span class="token string">"cockroachdb"</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> _set_url_database<span class="token punctuation">(</span>url<span class="token punctuation">,</span> database<span class="token operator">=</span><span class="token string">"defaultdb"</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token keyword">not</span> dialect_name <span class="token operator">==</span> <span class="token string">"sqlite"</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> _set_url_database<span class="token punctuation">(</span>url<span class="token punctuation">,</span> database<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> dialect_name <span class="token operator">==</span> <span class="token string">"mssql"</span> <span class="token keyword">and</span> dialect_driver <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token string">"pymssql"</span><span class="token punctuation">,</span> <span class="token string">"pyodbc"</span><span class="token punctuation">}</span><span class="token punctuation">:</span>
        engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>url<span class="token punctuation">,</span> connect_args<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"autocommit"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> dialect_name <span class="token operator">==</span> <span class="token string">"postgresql"</span> <span class="token keyword">and</span> dialect_driver <span class="token keyword">in</span> <span class="token punctuation">{</span>
        <span class="token string">"asyncpg"</span><span class="token punctuation">,</span>
        <span class="token string">"pg8000"</span><span class="token punctuation">,</span>
        <span class="token string">"psycopg2"</span><span class="token punctuation">,</span>
        <span class="token string">"psycopg2cffi"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">:</span>
        engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>url<span class="token punctuation">,</span> isolation_level<span class="token operator">=</span><span class="token string">"AUTOCOMMIT"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    <span class="token keyword">if</span> dialect_name <span class="token operator">==</span> <span class="token string">"sqlite"</span> <span class="token keyword">and</span> database <span class="token operator">!=</span> <span class="token string">":memory:"</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> database<span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>database<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> dialect_name <span class="token operator">==</span> <span class="token string">"postgresql"</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
            <span class="token comment"># Disconnect all users from the database we are dropping.</span>
            version <span class="token operator">=</span> conn<span class="token punctuation">.</span>dialect<span class="token punctuation">.</span>server_version_info
            pid_column <span class="token operator">=</span> <span class="token string">"pid"</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"procpid"</span>
            text <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
            SELECT pg_terminate_backend(pg_stat_activity.{pid_column})
            FROM pg_stat_activity
            WHERE pg_stat_activity.datname = '{database}'
            AND {pid_column} &lt;&gt; pg_backend_pid();
            """</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                pid_column<span class="token operator">=</span>pid_column<span class="token punctuation">,</span> database<span class="token operator">=</span>database
            <span class="token punctuation">)</span>
            <span class="token keyword">await</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>text<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment"># Drop the database.</span>
            text <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"DROP DATABASE </span><span class="token interpolation"><span class="token punctuation">{</span>quote<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token keyword">await</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>text<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
            text <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"DROP DATABASE </span><span class="token interpolation"><span class="token punctuation">{</span>quote<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token keyword">await</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>text<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> engine<span class="token punctuation">.</span>dispose<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Let's start by creating a <code>conftest.py</code> file in the root of our <code>tests/integration</code> directory. This file will be responsible for setting up the test database. Since this is an intricate setup, let's break it down into smaller pieces. We'll start with the imports:</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># tests/conftest.py</span>
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional

<span class="token keyword">import</span> pytest
<span class="token keyword">from</span> httpx <span class="token keyword">import</span> AsyncClient
<span class="token keyword">from</span> yarl <span class="token keyword">import</span> URL

<span class="token keyword">import</span> orm
<span class="token keyword">from</span> alembic<span class="token punctuation">.</span>command <span class="token keyword">import</span> upgrade
<span class="token keyword">from</span> app<span class="token punctuation">.</span>settings <span class="token keyword">import</span> settings
<span class="token keyword">from</span> orm<span class="token punctuation">.</span>session_manager <span class="token keyword">import</span> db_manager
<span class="token keyword">from</span> tests<span class="token punctuation">.</span>db_utils <span class="token keyword">import</span> alembic_config_from_url<span class="token punctuation">,</span> tmp_database<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>There isn't much action going here. We're importing the necessary packages. Let's move on and create our <code>app</code> and <code>client</code> fixtures, used to create the FastAPI test application and test client:</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># tests/conftest.py</span>
<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> main <span class="token keyword">import</span> app

    <span class="token keyword">yield</span> app


<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">client</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncClient<span class="token punctuation">(</span>app<span class="token operator">=</span>app<span class="token punctuation">,</span> base_url<span class="token operator">=</span><span class="token string">"http://test"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> client<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> client<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Because we use FastAPI, and it uses <code>anyio</code> we can use it in our tests. Many people are using <code>pytest-asyncio</code>. To skip testing on <code>trio</code> eventloop we need to create a new fixture. With it we also can just write <code>async def test_...</code> test functions without marking them additionally.</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># tests/conftest.py</span>
<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span>scope<span class="token operator">=</span><span class="token string">"session"</span><span class="token punctuation">,</span> autouse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">anyio_backend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"asyncio"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"use_uvloop"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span></span></code></pre>
<p>And now we're ready to create the database connection and session. Our test connection will be scoped to the session, so that we can use the same connection for all the tests, as it's best practice to avoid creating a new connection for each test, or even request.</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># tests/conftest.py</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span>scope<span class="token operator">=</span><span class="token string">"session"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pg_url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Provides base PostgreSQL URL for creating temporary databases."""</span>
    <span class="token keyword">return</span> URL<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>database_url<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span>scope<span class="token operator">=</span><span class="token string">"session"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">migrated_postgres_template</span><span class="token punctuation">(</span>pg_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Creates temporary database and applies migrations.

    Has "session" scope, so is called only once per tests run.
    """</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> tmp_database<span class="token punctuation">(</span>pg_url<span class="token punctuation">,</span> <span class="token string">"pytest"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tmp_url<span class="token punctuation">:</span>
        alembic_config <span class="token operator">=</span> alembic_config_from_url<span class="token punctuation">(</span>tmp_url<span class="token punctuation">)</span>
        <span class="token comment"># sometimes we have so called data-migrations.</span>
        <span class="token comment"># they can call different db-related functions etc..</span>
        <span class="token comment"># so we modify our settings</span>
        settings<span class="token punctuation">.</span>database_url <span class="token operator">=</span> tmp_url
        
        <span class="token comment"># It is important to always close the connections at the end of such migrations,</span>
        <span class="token comment"># or we will get errors like `source database is being accessed by other users`        </span>

        upgrade<span class="token punctuation">(</span>alembic_config<span class="token punctuation">,</span> <span class="token string">"head"</span><span class="token punctuation">)</span>

        <span class="token keyword">yield</span> tmp_url


<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span>scope<span class="token operator">=</span><span class="token string">"session"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">sessionmanager_for_tests</span><span class="token punctuation">(</span>migrated_postgres_template<span class="token punctuation">)</span><span class="token punctuation">:</span>
    db_manager<span class="token punctuation">.</span>init<span class="token punctuation">(</span>db_url<span class="token operator">=</span>migrated_postgres_template<span class="token punctuation">)</span>
    <span class="token comment"># can add another init (redis, etc...)</span>
    <span class="token keyword">yield</span> db_manager
    <span class="token keyword">await</span> db_manager<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">session</span><span class="token punctuation">(</span>sessionmanager_for_tests<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> db_manager<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> session

    <span class="token comment"># Clean tables after each test. I tried:</span>
    <span class="token comment"># 1. Create new database using an empty `migrated_postgres_template` as template</span>
    <span class="token comment"># (postgres could copy whole db structure)</span>
    <span class="token comment"># 2. Do TRUNCATE after each test.</span>
    <span class="token comment"># 3. Do DELETE after each test.</span>
    <span class="token comment"># DELETE FROM is the fastest</span>
    <span class="token comment"># https://www.lob.com/blog/truncate-vs-delete-efficiently-clearing-data-from-a-postgres-table</span>
    <span class="token comment"># BUT DELETE FROM query does not reset any AUTO_INCREMENT counter</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> db_manager<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        <span class="token keyword">for</span> table <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>orm<span class="token punctuation">.</span>OrmBase<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>sorted_tables<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># Clean tables in such order that tables which depend on another go first</span>
            <span class="token keyword">await</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>table<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>DELETE FROM</code> does not reset any AUTO_INCREMENT counter so our user.id attribute is going to increase during single tests run. You should consider if it's bad for you or not. For me it's no problem, I don't want to switch to TRUNCATE.</p>
<p>Now we can write our first and simple test</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># tests/test_orm_works.py</span>

<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> text

<span class="token keyword">import</span> orm


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_orm_session</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> orm<span class="token punctuation">.</span>User<span class="token punctuation">(</span>
        name<span class="token operator">=</span><span class="token string">"Michael"</span><span class="token punctuation">,</span>
        fullname<span class="token operator">=</span><span class="token string">"Michael Test Jr."</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token keyword">await</span> session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

    rows <span class="token operator">=</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>text<span class="token punctuation">(</span><span class="token string">'SELECT id, name, fullname FROM "user_account"'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"Michael"</span>
    <span class="token keyword">assert</span> result<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"Michael Test Jr."</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>You could run <code>pytest</code> and it works.</p>
<p>But we're not done yet. We need to add very useful <code>Stairway test</code> and doing so we will face a new challenges with Alembic.</p>
<h3 id=stairway-test>Stairway test</h3>
<p>Simple and efficient method to check that migration does not have typos and rolls back all schema changes. Does not require maintenance - you can add this test to your project once and forget about it.</p>
<p>In particular, test detects the data types, that were previously created by <code>upgrade()</code> method and were not removed by <code>downgrade()</code>: when creating a table/column, Alembic automatically creates custom data types specified in columns (e.g. enum), but does not delete them when deleting table or column - developer has to do it manually.</p>
<h4 id=how-it-works>How it works</h4>
<p>Test retrieves all migrations list, and for each migration executes <code>upgrade</code>, <code>downgrade</code>, <code>upgrade</code> Alembic commands.</p>
<figure class="kg-card kg-image-card"><a href=https://thedmitry.pw/content/images/2023/08/stairway-1.gif class="zoom fluidbox__instance-3 fluidbox--initialized fluidbox--closed fluidbox--ready"><div class=fluidbox__wrap style=z-index:990><img src="data:image/gif;base64,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at3KtavXr2DDih1LtqzZs2jTql3Ltq3bt3D/48qdS7eu3bt48+rdy7ev37+AAwseTLiw4cOIEytezLix48eQI0ueTLmy5cuYM2vezLmz58+gQ4seTbq06dOoU6tezbq169ewY8ueTbu27du4c+vezbu379/AgwsfTry48ePIkytfzry58+fQo0ufTr269evYs2vfzr279+/gw4sfT748wS7o06tfz769+/fw48ufT7++/fv48+vfz7+///8ABihgfYkMaOCB8CmC4IIMdqFggxAK+GCEFPY3YYUY4ndhhhzOt2GHILr3YYgkpjdiiSRahOKKLLbo4oswxvhegTJ2eGKNDd6I44I67nhgjz4OCGSQAQ5J5H9GHmkh/41KMqhik1BGKeWUVBKISJVCMoklklpuueSVXnIJZphfHkKmf0meKWKXat6XZpvrPQnnnHTWaeeMY94p35t18kmnn3MCCqegbRKqpqFnIkqmnHo26uijUrIJqXqKhlmpl5dumSmWm1bZKZWfThlqpBVNauqpqLYo6amjRtkqlK82GauSsx5ZK5G3Bpmrj4ym6uuvwP6Yp6+77lgsjsfWmKyMy8bYLIzPvhiti70Ga+212NK3qqnTqrrtpN2yGO6K46JYbonnpvgtpNVm6+672a77aLoh0guivTbK6yi+HPKbob8YAlxhu/AWbDCrw6YqMIULR9gwhA/nqG+jETs5sf+eFfNY6sEcd8xuwqhmjKDIwoKMsMncXnwnyQaynCXK4G7s8cw0DwrzxzfPq7KdLku4c58//xl0oEPbnPO+Mtes9NKgHk1x0YVCfajUiVK9qNWWYo2p1ppyzWnSTIctNq9OY+y1p2c3XfbKaYvaNqlr8/y2q3PDCvbYeOctbtxA8y2030QDbrSZwfZcZN2yIk6r4rberffjkAcseNSTT1151ZdfnXnWm2/dedeffx062hRFbvrpDo+uNuHAGg6g62Ky/ivsaDKOq+264k526aj37vvhshOru7HDI1u8ssczm7yzy0PbvLTPU+v479RXv6fqbmMPd/AKR++t9nSDb7f/+ImTv7j5jfNu/frsr8l9yN7vjf7t8+de/+7vn5x/yvcT37/x6mufANsXP3IV0FwHRFcC1fU/5DVQeQ9kXgSdN0HoBXCAGKTeAuu1wXt1MF8VlF4Iv7e/mI1QfiXEWQp1dsEMuvB0H+xX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" class="kg-image fluidbox__thumb" alt loading=lazy srcset sizes style=opacity:1 width=1560 height=541><div class=fluidbox__ghost style=width:800px;height:277.433px;top:0px;left:0px></div><div class=fluidbox__loader style=z-index:2></div></div></a></figure>
<p>Let's add new test package <code>migrations</code> and create fixtures</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># tests/migrations/conftest.py</span>

<span class="token keyword">import</span> pytest
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> create_async_engine

<span class="token keyword">from</span> tests<span class="token punctuation">.</span>db_utils <span class="token keyword">import</span> alembic_config_from_url<span class="token punctuation">,</span> tmp_database


<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">postgres</span><span class="token punctuation">(</span>pg_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Creates empty temporary database.
    """</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> tmp_database<span class="token punctuation">(</span>pg_url<span class="token punctuation">,</span> <span class="token string">"pytest"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tmp_url<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> tmp_url


<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">postgres_engine</span><span class="token punctuation">(</span>postgres<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    SQLAlchemy engine, bound to temporary database.
    """</span>
    engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>
        url<span class="token operator">=</span>postgres<span class="token punctuation">,</span>
        pool_pre_ping<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> engine
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> engine<span class="token punctuation">.</span>dispose<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">alembic_config</span><span class="token punctuation">(</span>postgres<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Alembic configuration object, bound to temporary database.
    """</span>
    <span class="token keyword">return</span> alembic_config_from_url<span class="token punctuation">(</span>postgres<span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>And the test itself:</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># tests/migrations/test_stairway.py</span>

<span class="token triple-quoted-string string">"""
Test can find forgotten downgrade methods, undeleted data types in downgrade
methods, typos and many other errors.

Does not require any maintenance - you just add it once to check 80% of typos
and mistakes in migrations forever.
"""</span>
<span class="token keyword">import</span> pytest

<span class="token keyword">from</span> alembic<span class="token punctuation">.</span>command <span class="token keyword">import</span> downgrade<span class="token punctuation">,</span> upgrade
<span class="token keyword">from</span> alembic<span class="token punctuation">.</span>config <span class="token keyword">import</span> Config
<span class="token keyword">from</span> alembic<span class="token punctuation">.</span>script <span class="token keyword">import</span> Script<span class="token punctuation">,</span> ScriptDirectory
<span class="token keyword">from</span> tests<span class="token punctuation">.</span>db_utils <span class="token keyword">import</span> alembic_config_from_url


<span class="token keyword">def</span> <span class="token function">get_revisions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Create Alembic configuration object</span>
    <span class="token comment"># (we don't need database for getting revisions list)</span>
    config <span class="token operator">=</span> alembic_config_from_url<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Get directory object with Alembic migrations</span>
    revisions_dir <span class="token operator">=</span> ScriptDirectory<span class="token punctuation">.</span>from_config<span class="token punctuation">(</span>config<span class="token punctuation">)</span>

    <span class="token comment"># Get &amp; sort migrations, from first to last</span>
    revisions <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>revisions_dir<span class="token punctuation">.</span>walk_revisions<span class="token punctuation">(</span><span class="token string">"base"</span><span class="token punctuation">,</span> <span class="token string">"heads"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    revisions<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> revisions


<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>parametrize</span><span class="token punctuation">(</span><span class="token string">"revision"</span><span class="token punctuation">,</span> get_revisions<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test_migrations_stairway</span><span class="token punctuation">(</span>alembic_config<span class="token punctuation">:</span> Config<span class="token punctuation">,</span> revision<span class="token punctuation">:</span> Script<span class="token punctuation">)</span><span class="token punctuation">:</span>
    upgrade<span class="token punctuation">(</span>alembic_config<span class="token punctuation">,</span> revision<span class="token punctuation">.</span>revision<span class="token punctuation">)</span>

    <span class="token comment"># We need -1 for downgrading first migration (its down_revision is None)</span>
    downgrade<span class="token punctuation">(</span>alembic_config<span class="token punctuation">,</span> revision<span class="token punctuation">.</span>down_revision <span class="token keyword">or</span> <span class="token string">"-1"</span><span class="token punctuation">)</span>
    upgrade<span class="token punctuation">(</span>alembic_config<span class="token punctuation">,</span> revision<span class="token punctuation">.</span>revision<span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Running pytest again we will get an error:</p>
<p><code>E RuntimeError: asyncio.run() cannot be called from a running event loop</code></p>
<p>That's because inside <code>upgrade</code> command alembic use <code>asyncio.run</code> to run migrations via <code>asyncpg</code> driver. That works just fine then we run migration commands from command line, but during test run an active asyncio event loop is already in place and we can't use <code>asyncio.run</code> </p>
<p>We are definitely don't want to rewrite alembic internals. But we need some way to run an async function from sync <code>run_migrations_online</code> while eventloop is already running.</p>
<p>I decided do the following:</p>
<ul><li>check for running eventloop, it there is none, we can run standard alembic's way<li>if there is an eventloop we can use <code>asyncio.create_task</code> to wrap our migration command.<li>the problem is that we need somehow to <code>await</code> this task inside our pytest fixture, while creating it during alembic <code>upgrade</code> command.<li>to solve this problem I decided to add a new variable to <code>conftest.py</code> and set it from alembic. Yeap, it's kind of a global variable, but I fail to find more elegant solution.</ul>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># tests/conftest.py</span>
<span class="token comment">#... add to the end</span>
MIGRATION_TASK<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Task<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span>scope<span class="token operator">=</span><span class="token string">"session"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">migrated_postgres_template</span><span class="token punctuation">(</span>pg_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Creates temporary database and applies migrations.

    Has "session" scope, so is called only once per tests run.
    """</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> tmp_database<span class="token punctuation">(</span>pg_url<span class="token punctuation">,</span> <span class="token string">"pytest"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tmp_url<span class="token punctuation">:</span>
        alembic_config <span class="token operator">=</span> alembic_config_from_url<span class="token punctuation">(</span>tmp_url<span class="token punctuation">)</span>
        upgrade<span class="token punctuation">(</span>alembic_config<span class="token punctuation">,</span> <span class="token string">"head"</span><span class="token punctuation">)</span>

        <span class="token keyword">await</span> MIGRATION_TASK <span class="token comment"># added line</span>

        <span class="token keyword">yield</span> tmp_url<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># alembic/env.py</span>

<span class="token keyword">def</span> <span class="token function">run_migrations_online</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Run migrations in 'online' mode."""</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        current_loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> RuntimeError<span class="token punctuation">:</span>
        <span class="token comment"># there is no loop, can use asyncio.run</span>
        asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>run_async_migrations<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>

    <span class="token keyword">from</span> tests <span class="token keyword">import</span> conftest
    conftest<span class="token punctuation">.</span>MIGRATION_TASK <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>run_async_migrations<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Everythig should be fine, right?! Right?! </p>
<p>Well, not quite. We've got ourselves a new error:</p>
<pre class="line-numbers language-python"><code class=language-python>E       AttributeError<span class="token punctuation">:</span> <span class="token string">'NoneType'</span> <span class="token builtin">object</span> has no attribute <span class="token string">'configure'</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>alembic<span class="token operator">/</span>env<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">61</span><span class="token punctuation">:</span> AttributeError<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span></span></code></pre>
<p>What is going on? After reading sources of alembic it's get clear:</p>
<ol><li>When we run <code>upgrade</code> command, alembic loads some data into <code>context</code> object using special context-manager:</ol>
<pre class="line-numbers language-python"><code class=language-python><span class="token keyword">with</span> EnvironmentContext<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    script<span class="token punctuation">.</span>run_env<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre>
<ol start=2><li><code>run_env</code> method loads our <code>alembic/env.py</code> and invokes <code>run_migrations_online()</code><li>We create asyncio Task and return from <code>run_migrations_online</code>. It ends the context manager and clears <code>context</code> object. So when we are trying to actually run some code inside this task, we already don't have some parameters. <code>context</code> is None and that's why we got an error shown before.</ol>
<p>So we need somehow to pass data into our async task. To do that I decided to use <code>contextvars</code>. If we create contexvars before creating asyncio.Task then this task will get a copy of contextvars and will be able to use them.</p>
<p>Let's start with import and process of setting the context variable.</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># alembic/env.py</span>
<span class="token keyword">from</span> contextvars <span class="token keyword">import</span> ContextVar

ctx_var<span class="token punctuation">:</span> ContextVar<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> ContextVar<span class="token punctuation">(</span><span class="token string">"ctx_var"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">run_migrations_online</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Run migrations in 'online' mode."""</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        current_loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> RuntimeError<span class="token punctuation">:</span>
        <span class="token comment"># there is no loop, can use asyncio.run</span>
        asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>run_async_migrations<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">from</span> tests <span class="token keyword">import</span> conftest
    ctx_var<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"config"</span><span class="token punctuation">:</span> context<span class="token punctuation">.</span>config<span class="token punctuation">,</span>
        <span class="token string">"script"</span><span class="token punctuation">:</span> context<span class="token punctuation">.</span>script<span class="token punctuation">,</span>
        <span class="token string">"opts"</span><span class="token punctuation">:</span> context<span class="token punctuation">.</span>_proxy<span class="token punctuation">.</span>context_opts<span class="token punctuation">,</span>  <span class="token comment"># type: ignore</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    conftest<span class="token punctuation">.</span>MIGRATION_TASK <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>run_async_migrations<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Next step - using this contextvar</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># alembic/env.py</span>

<span class="token keyword">def</span> <span class="token function">do_run_migrations</span><span class="token punctuation">(</span>connection<span class="token punctuation">:</span> Connection<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        context<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>connection<span class="token operator">=</span>connection<span class="token punctuation">,</span> target_metadata<span class="token operator">=</span>target_metadata<span class="token punctuation">)</span>

        <span class="token keyword">with</span> context<span class="token punctuation">.</span>begin_transaction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            context<span class="token punctuation">.</span>run_migrations<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> AttributeError<span class="token punctuation">:</span>
        context_data <span class="token operator">=</span> ctx_var<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> EnvironmentContext<span class="token punctuation">(</span>
                config<span class="token operator">=</span>context_data<span class="token punctuation">[</span><span class="token string">"config"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                script<span class="token operator">=</span>context_data<span class="token punctuation">[</span><span class="token string">"script"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token operator">**</span>context_data<span class="token punctuation">[</span><span class="token string">"opts"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">:</span>
            context<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>connection<span class="token operator">=</span>connection<span class="token punctuation">,</span> target_metadata<span class="token operator">=</span>target_metadata<span class="token punctuation">)</span>
            <span class="token keyword">with</span> context<span class="token punctuation">.</span>begin_transaction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                context<span class="token punctuation">.</span>run_migrations<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>That's it. Now you can run pytest and see that everything is ok.</p>
<p>This setup allow you to use <code>pytest-xdist</code>. This package splits your test suite into chunks and runs each chunk in different process. It could speed up you tests if you have a lot of them. And because each process will create its own unique test database it works without any problems.</p>
<p>Finally, just some clumsy integration test to show than our API is working</p>
<pre class="line-numbers language-python"><code class=language-python><span class="token comment"># tests/test_api.py</span>

<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> status


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_my_api</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Test to show that api is working</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/api/users/"</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> status<span class="token punctuation">.</span>HTTP_200_OK
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
        <span class="token string">"/api/users/"</span><span class="token punctuation">,</span>
        json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"test@example.com"</span><span class="token punctuation">,</span> <span class="token string">"full_name"</span><span class="token punctuation">:</span> <span class="token string">"Full Name Test"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> status<span class="token punctuation">.</span>HTTP_201_CREATED
    new_user_id <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span>

    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/api/users/</span><span class="token interpolation"><span class="token punctuation">{</span>new_user_id<span class="token punctuation">}</span></span><span class="token string">/"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> status<span class="token punctuation">.</span>HTTP_200_OK
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{</span>
        <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
        <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"id"</span><span class="token punctuation">:</span> new_user_id<span class="token punctuation">,</span>
            <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"test@example.com"</span><span class="token punctuation">,</span>
            <span class="token string">"full_name"</span><span class="token punctuation">:</span> <span class="token string">"Full Name Test"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/api/users/"</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> status<span class="token punctuation">.</span>HTTP_200_OK
    <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash"><code class=language-bash>$ pytest <span class="token builtin class-name">.</span> --vv -x
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> <span class="token builtin class-name">test</span> session starts <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
platform darwin -- Python <span class="token number">3.9</span>.15, pytest-7.4.0, pluggy-1.2.0 -- /venv-8ZwWMPCX-py3.9/bin/python
cachedir: .pytest_cache
rootdir: /Users/something/blog_article_v2
plugins: anyio-3.7.1
collected <span class="token number">3</span> items                                                                                                                                                                             

tests/test_api.py::test_my_api PASSED                                                                                                                                                   <span class="token punctuation">[</span> <span class="token number">33</span>%<span class="token punctuation">]</span>
tests/test_orm_works.py::test_orm_session PASSED                                                                                                                                        <span class="token punctuation">[</span> <span class="token number">66</span>%<span class="token punctuation">]</span>
tests/migrations/test_stairway.py::test_migrations_stairway<span class="token punctuation">[</span>revision0<span class="token punctuation">]</span> PASSED                                                                                                           <span class="token punctuation">[</span><span class="token number">100</span>%<span class="token punctuation">]</span>

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> <span class="token number">3</span> passed <span class="token keyword">in</span> <span class="token number">1</span>.48s <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Hope it is going to be useful to someone and Google will index this article someday. <code><sup>^.^</sup></code> Have a nice day!</p>
 </div>
 </section>
 </article>
 </div>
</main>
<aside class="read-next outer">
 <div class=inner>
 <div class=read-next-feed>
 <article class=read-next-card>
 <header class=read-next-card-header>
 <h3><span>More in</span> <a href=https://thedmitry.pw/tag/python_tips/>python_tips</a></h3>
 </header>
 <div class=read-next-card-content>
 <ul>
 <li>
 <h4><a href=https://thedmitry.pw/blog/2021/08/multistage-docker-python-venv/>Multistage docker build</a></h4>
 <div class=read-next-card-meta>
 <p><time datetime=2021-08-24>24 Aug 2021</time> –
 4 min read</p>
 </div>
 </li>
 <li>
 <h4><a href=https://thedmitry.pw/blog/2021/04/creating-abstract-method/>Creating abstract method</a></h4>
 <div class=read-next-card-meta>
 <p><time datetime=2021-04-19>19 Apr 2021</time> –
 1 min read</p>
 </div>
 </li>
 <li>
 <h4><a href=https://thedmitry.pw/blog/2021/03/ignoring-exceptions/>Ignoring Exceptions</a></h4>
 <div class=read-next-card-meta>
 <p><time datetime=2021-03-06>6 Mar 2021</time> –
 1 min read</p>
 </div>
 </li>
 </ul>
 </div>
 <footer class=read-next-card-footer>
 <a href=https://thedmitry.pw/tag/python_tips/>See all 7 posts
 →</a>
 </footer>
 </article>
 <article class="post-card post tag-python_tips tag-docker no-image">
 <div class=post-card-content>
 <a class=post-card-content-link href=https://thedmitry.pw/blog/2021/08/multistage-docker-python-venv/>
 <header class=post-card-header>
 <div class=post-card-primary-tag>python_tips</div>
 <h2 class=post-card-title>Multistage docker build</h2>
 </header>
 <section class=post-card-excerpt>
 <p>Problems with C extensions and shared libraries. You can't just copy virtual environment. I wrote a python script to search for system dependencies.</p>
 </section>
 </a>
 <footer class=post-card-meta>
 <ul class=author-list>
 <li class=author-list-item>
 
 <div class=author-name-tooltip>
 Dmitry Plevkov
 </div>
 
 <a href=https://thedmitry.pw/author/dmitry/ class=static-avatar>
 <img class=author-profile-image src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill-opacity="0"/></svg>' alt="Dmitry Plevkov" style="background-blend-mode:normal!important;background-clip:content-box!important;background-position:50% 50%!important;background-color:rgb(227,233,237)!important;background-image:var(--sf-img-1)!important;background-size:cover!important;background-origin:content-box!important;background-repeat:no-repeat!important">
 </a>
 </li>
 </ul>
 <div class=post-card-byline-content>
 <span><a href=https://thedmitry.pw/author/dmitry/>Dmitry Plevkov</a></span>
 <span class=post-card-byline-date><time datetime=2021-08-24>24 Aug 2021</time> <span class=bull>•</span> 4 min read</span>
 </div>
 </footer>
 </div>
</article>
 </div>
 </div>
</aside>
 <footer class="site-footer outer">
 <div class="site-footer-content inner">
 <section class=copyright><a href=https://thedmitry.pw/>Dmitry's website</a> © 2023</section>
 <nav class=site-footer-nav>
 <a href=https://thedmitry.pw/>Latest Posts</a>
 
 
 </nav>
 </div>
 </footer>
 </div>
 
 
 
 
 
 
 
 
<div id=ghost-portal-root></div><div id=sodo-search-root></div><div id=caption-overlay><div class=img-caption></div></div>